<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FigStudio</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;0,9..40,800;1,9..40,400&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0A0A0B;
    --bg-secondary: #131316;
    --bg-tertiary: #1C1C21;
    --bg-hover: #232329;
    --border: #2A2A32;
    --border-light: #35353F;
    --text: #F0F0F3;
    --text-muted: #9999A8;
    --text-subtle: #6B6B7B;
    --accent: #A67C52;
    --accent-hover: #B88B60;
    --accent-glow: rgba(166, 124, 82, 0.15);
    --accent-soft: rgba(166, 124, 82, 0.08);
    --accent-bronze: #A67C52;
    --accent-warm: #8B7355;
    --samurai-red: #C41E3A;
    --green: #34D399;
    --green-soft: rgba(52, 211, 153, 0.1);
    --amber: #FBBF24;
    --amber-soft: rgba(251, 191, 36, 0.1);
    --red: #F87171;
    --fig-gradient: linear-gradient(135deg, #A67C52, #8B7355);
    --radius: 12px;
    --radius-sm: 8px;
    --radius-xs: 6px;
    --shadow: 0 1px 3px rgba(0,0,0,0.3);
    --shadow-lg: 0 8px 30px rgba(0,0,0,0.4);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  /* ===== TOP BAR ===== */
  .topbar {
    height: 52px;
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    flex-shrink: 0;
    z-index: 10;
  }

  .topbar-left {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .logo-mark {
    width: 28px; height: 28px;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }

  .logo-mark svg {
    width: 24px; height: 24px;
  }

  .logo-text {
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--text);
  }

  .logo-text span {
    color: var(--accent-bronze);
  }

  .topbar-status {
    font-size: 11px;
    color: var(--text-subtle);
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .status-dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--green);
    box-shadow: 0 0 6px rgba(52, 211, 153, 0.5);
  }

  .topbar-right {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .topbar-btn {
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    color: var(--text-muted);
    font-size: 11px;
    font-weight: 500;
    padding: 5px 12px;
    border-radius: var(--radius-xs);
    cursor: pointer;
    transition: all 0.15s;
    font-family: inherit;
  }
  .topbar-btn:hover { background: var(--bg-hover); color: var(--text); border-color: var(--border-light); }

  /* ===== MAIN LAYOUT ===== */
  .main {
    flex: 1;
    display: flex;
    overflow: hidden;
  }

  /* ===== CHAT PANEL ===== */
  .chat-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
    border-right: 1px solid var(--border);
  }

  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 24px 24px 16px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    scroll-behavior: smooth;
  }

  .chat-messages::-webkit-scrollbar { width: 5px; }
  .chat-messages::-webkit-scrollbar-track { background: transparent; }
  .chat-messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  .msg {
    max-width: 720px;
    line-height: 1.65;
    font-size: 14px;
    animation: msgIn 0.3s ease-out;
  }

  @keyframes msgIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .msg-assistant {
    color: var(--text);
  }

  .msg-assistant .msg-label {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--accent);
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .msg-assistant .msg-body {
    color: var(--text);
  }

  .msg-assistant .msg-body p { margin-bottom: 10px; }
  .msg-assistant .msg-body p:last-child { margin-bottom: 0; }
  .msg-assistant .msg-body strong { color: var(--text); font-weight: 600; }
  .msg-assistant .msg-body em { color: var(--text-muted); font-style: italic; }
  .msg-assistant .msg-body code {
    background: var(--bg-tertiary);
    padding: 1px 5px;
    border-radius: 4px;
    font-size: 13px;
  }

  .msg-user {
    align-self: flex-end;
    margin-left: auto;
  }

  .msg-user .msg-body {
    background: var(--accent-soft);
    border: 1px solid rgba(166, 124, 82, 0.2);
    border-radius: var(--radius) var(--radius-xs) var(--radius) var(--radius);
    padding: 12px 16px;
    color: var(--text);
  }

  /* ===== MESSAGE ACTIONS ===== */
  .msg-actions {
    display: flex;
    gap: 4px;
    margin-top: 6px;
    opacity: 0;
    transition: opacity 0.15s;
  }

  .msg:hover .msg-actions,
  .msg-actions.visible {
    opacity: 1;
  }

  .msg-action-btn {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 3px 8px;
    border-radius: 4px;
    background: none;
    border: 1px solid transparent;
    color: var(--text-subtle);
    font-size: 11px;
    font-family: inherit;
    cursor: pointer;
    transition: all 0.15s;
  }

  .msg-action-btn:hover {
    background: var(--bg-tertiary);
    border-color: var(--border);
    color: var(--text-muted);
  }

  .msg-action-btn.copied {
    color: var(--green);
  }

  /* ===== STOP BUTTON ===== */
  .stop-btn {
    display: none;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 6px 14px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    border-radius: var(--radius-xs);
    color: var(--text-muted);
    font-size: 12px;
    font-weight: 500;
    font-family: inherit;
    cursor: pointer;
    margin: 0 auto 8px;
    transition: all 0.15s;
  }

  .stop-btn:hover {
    background: var(--bg-hover);
    color: var(--text);
    border-color: var(--border-light);
  }

  .stop-btn.active {
    display: flex;
  }

  /* ===== THINKING INDICATOR ===== */
  .thinking {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 0;
    animation: msgIn 0.3s ease-out;
  }

  .thinking-dots {
    display: flex;
    gap: 4px;
  }

  .thinking-dots span {
    width: 5px; height: 5px;
    border-radius: 50%;
    background: var(--accent);
    animation: dot 1.2s infinite ease-in-out;
  }
  .thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
  .thinking-dots span:nth-child(3) { animation-delay: 0.4s; }

  @keyframes dot {
    0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); }
    40% { opacity: 1; transform: scale(1); }
  }

  .thinking-text {
    font-size: 12px;
    color: var(--text-subtle);
  }

  /* ===== URL ANALYSIS INDICATOR ===== */
  .url-analysis {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    background: var(--accent-soft);
    border: 1px solid rgba(166, 124, 82, 0.15);
    border-radius: var(--radius-xs);
    margin: 4px 0;
    animation: msgIn 0.3s ease-out;
  }

  .url-analysis-spinner {
    width: 14px; height: 14px;
    border: 2px solid rgba(166, 124, 82, 0.2);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .url-analysis-text {
    font-size: 12px;
    color: var(--accent);
    font-weight: 500;
  }

  /* Mode discovery hint */
  .mode-hint {
    margin: 8px 0;
    animation: msgIn 0.3s ease-out;
    transition: opacity 0.3s, transform 0.3s;
  }
  .mode-hint-content {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 14px;
    background: linear-gradient(135deg, rgba(166, 124, 82, 0.06), rgba(166, 124, 82, 0.12));
    border: 1px solid rgba(166, 124, 82, 0.15);
    border-radius: var(--radius-sm);
    font-size: 12.5px;
    color: var(--text-secondary);
    line-height: 1.4;
  }
  .mode-hint-content svg {
    flex-shrink: 0;
    color: var(--accent);
    opacity: 0.7;
  }
  .mode-hint-content strong {
    color: var(--accent);
    font-weight: 600;
  }
  .mode-hint-dismiss {
    flex-shrink: 0;
    margin-left: auto;
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 14px;
    padding: 2px 4px;
    opacity: 0.5;
    transition: opacity 0.2s;
  }
  .mode-hint-dismiss:hover {
    opacity: 1;
  }

  /* Beta testing pulse & report */
  .beta-pulse {
    margin: 8px 0;
    animation: msgIn 0.3s ease-out;
    transition: opacity 0.3s, transform 0.3s;
  }
  .beta-pulse-content {
    padding: 12px 16px;
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(59, 130, 246, 0.10));
    border: 1px solid rgba(59, 130, 246, 0.15);
    border-radius: var(--radius-sm);
  }
  .beta-pulse-badge {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: rgba(59, 130, 246, 0.7);
    margin-bottom: 6px;
  }
  .beta-pulse-question {
    font-size: 13px;
    color: var(--text-primary);
    margin-bottom: 10px;
    font-weight: 500;
  }
  .beta-pulse-options {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 8px;
    transition: opacity 0.3s;
  }
  .beta-pulse-option {
    padding: 5px 12px;
    border: 1px solid rgba(59, 130, 246, 0.2);
    border-radius: 16px;
    background: white;
    color: var(--text-secondary);
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .beta-pulse-option:hover {
    border-color: rgba(59, 130, 246, 0.5);
    color: rgb(59, 130, 246);
    background: rgba(59, 130, 246, 0.05);
  }
  .beta-pulse-option.selected {
    border-color: rgb(59, 130, 246);
    background: rgba(59, 130, 246, 0.1);
    color: rgb(59, 130, 246);
    font-weight: 600;
  }
  .beta-pulse-option:disabled {
    cursor: default;
    opacity: 0.6;
  }
  .beta-pulse-comment {
    width: 100%;
    border: 1px solid rgba(59, 130, 246, 0.15);
    border-radius: var(--radius-xs);
    padding: 6px 10px;
    font-size: 12px;
    font-family: inherit;
    resize: none;
    transition: height 0.2s;
    outline: none;
  }
  .beta-pulse-comment:focus {
    border-color: rgba(59, 130, 246, 0.3);
  }

  .beta-report {
    margin: 16px 0;
    animation: msgIn 0.3s ease-out;
  }
  .beta-report-content {
    padding: 16px 20px;
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(59, 130, 246, 0.08));
    border: 1px solid rgba(59, 130, 246, 0.15);
    border-radius: var(--radius-sm);
  }
  .beta-report-title {
    font-size: 14px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 12px;
  }
  .beta-report-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-bottom: 12px;
  }
  .beta-stat {
    text-align: center;
    padding: 8px;
    background: white;
    border-radius: var(--radius-xs);
    border: 1px solid var(--border);
  }
  .beta-stat-value {
    display: block;
    font-size: 18px;
    font-weight: 700;
    color: var(--text-primary);
  }
  .beta-stat-label {
    display: block;
    font-size: 10px;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.3px;
    margin-top: 2px;
  }
  .beta-report-section {
    margin-bottom: 12px;
    font-size: 12px;
    color: var(--text-secondary);
  }
  .beta-report-section strong {
    color: var(--text-primary);
    display: block;
    margin-bottom: 4px;
  }
  .beta-feedback-item {
    padding: 4px 0;
    border-bottom: 1px solid var(--border);
  }
  .beta-report-actions {
    display: flex;
    gap: 8px;
  }
  .beta-report-btn {
    padding: 6px 14px;
    border: 1px solid rgba(59, 130, 246, 0.2);
    border-radius: var(--radius-xs);
    background: white;
    color: var(--text-secondary);
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .beta-report-btn:hover {
    border-color: rgba(59, 130, 246, 0.4);
    color: rgb(59, 130, 246);
  }
  .beta-flags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 4px;
  }
  .beta-flag {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
    background: rgba(107, 114, 128, 0.1);
    color: var(--text-secondary);
  }
  .beta-flag-good {
    background: rgba(16, 185, 129, 0.1);
    color: rgb(16, 185, 129);
  }
  .beta-flag-bad {
    background: rgba(239, 68, 68, 0.08);
    color: rgb(220, 38, 38);
  }

  /* ===== INPUT AREA ===== */
  .input-area {
    padding: 16px 24px 20px;
    border-top: 1px solid var(--border);
    background: var(--bg-secondary);
  }

  .input-box {
    display: flex;
    align-items: flex-end;
    gap: 10px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 10px 14px;
    transition: border-color 0.2s;
  }

  .input-box:focus-within {
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent-glow);
  }

  .input-box textarea {
    flex: 1;
    background: none;
    border: none;
    color: var(--text);
    font-family: inherit;
    font-size: 14px;
    line-height: 1.5;
    resize: none;
    outline: none;
    max-height: 120px;
    min-height: 21px;
  }

  .input-box textarea::placeholder { color: var(--text-subtle); }

  .send-btn {
    width: 32px; height: 32px;
    border-radius: var(--radius-xs);
    background: var(--fig-gradient);
    border: none;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: opacity 0.15s, transform 0.15s;
  }
  .send-btn:hover { opacity: 0.9; transform: scale(1.05); }
  .send-btn:disabled { opacity: 0.3; cursor: not-allowed; transform: none; }

  .input-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 8px;
    padding: 0 2px;
  }

  .input-hint {
    font-size: 11px;
    color: var(--text-subtle);
  }

  .mode-indicator {
    display: flex;
    gap: 4px;
  }

  .mode-pill {
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 10px;
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text-subtle);
    cursor: pointer;
    transition: all 0.15s;
    font-family: inherit;
  }
  .mode-pill.active {
    background: var(--accent-soft);
    border-color: rgba(166, 124, 82, 0.3);
    color: var(--accent);
  }
  .mode-pill:hover { border-color: var(--border-light); color: var(--text-muted); }

  /* ===== PREVIEW PANEL ===== */
  .preview-panel {
    width: 48%;
    max-width: 600px;
    display: flex;
    flex-direction: column;
    background: var(--bg);
    overflow: hidden;
  }

  .preview-header {
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 16px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .preview-header-left {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .preview-title {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-subtle);
  }

  .preview-version {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .preview-version-btn {
    width: 22px; height: 22px;
    border-radius: 4px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    color: var(--text-subtle);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    transition: all 0.15s;
    font-family: inherit;
    padding: 0;
  }
  .preview-version-btn:hover:not(:disabled) { background: var(--bg-hover); color: var(--text); border-color: var(--border-light); }
  .preview-version-btn:disabled { opacity: 0.25; cursor: not-allowed; }

  .preview-version-label {
    font-size: 10px;
    color: var(--text-subtle);
    font-weight: 500;
    min-width: 40px;
    text-align: center;
  }

  .preview-actions {
    display: flex;
    gap: 6px;
  }

  .preview-body {
    flex: 1;
    overflow-x: hidden;
    overflow-y: auto;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    position: relative;
  }

  .preview-empty {
    text-align: center;
    padding: 40px;
  }

  .preview-empty-icon {
    width: 48px; height: 48px;
    border-radius: 12px;
    background: var(--bg-tertiary);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 14px;
  }

  .preview-empty h3 {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-muted);
    margin-bottom: 6px;
  }

  .preview-empty p {
    font-size: 12px;
    color: var(--text-subtle);
    line-height: 1.5;
    max-width: 260px;
    margin: 0 auto;
  }

  .preview-iframe {
    width: 100%;
    height: 100%;
    border: none;
    background: white;
    display: none;
    overflow-x: hidden;
  }

  /* ===== SETUP MODAL ===== */
  .setup-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(8px);
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .setup-modal {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 36px 40px;
    width: 420px;
    box-shadow: var(--shadow-lg);
  }

  .setup-modal h2 {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 6px;
  }

  .setup-modal .setup-subtitle {
    font-size: 13px;
    color: var(--text-muted);
    margin-bottom: 20px;
    line-height: 1.5;
  }

  .setup-field {
    margin-bottom: 16px;
  }

  .setup-field label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-muted);
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .setup-field input {
    width: 100%;
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 10px 14px;
    color: var(--text);
    font-family: inherit;
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s;
  }

  .setup-field input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent-glow);
  }

  .setup-field input::placeholder { color: var(--text-subtle); }

  .setup-start {
    width: 100%;
    padding: 12px;
    background: var(--fig-gradient);
    border: none;
    border-radius: var(--radius-sm);
    color: white;
    font-family: inherit;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 8px;
    transition: opacity 0.15s;
  }
  .setup-start:hover { opacity: 0.9; }
  .setup-start:disabled { opacity: 0.4; cursor: not-allowed; }

  .setup-note {
    font-size: 11px;
    color: var(--text-subtle);
    text-align: center;
    margin-top: 12px;
    line-height: 1.4;
  }

  /* ===== MARKDOWN RENDERING ===== */
  .msg-body h2 {
    font-size: 14px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--accent);
    margin: 18px 0 8px;
    padding-bottom: 4px;
    border-bottom: 1px solid var(--border);
  }

  .msg-body h3 {
    font-size: 13px;
    font-weight: 600;
    margin: 14px 0 6px;
    color: var(--text);
  }

  .msg-body ul, .msg-body ol {
    padding-left: 20px;
    margin-bottom: 10px;
  }

  .msg-body li {
    margin-bottom: 4px;
  }

  .msg-body blockquote {
    border-left: 3px solid var(--accent);
    padding-left: 12px;
    margin: 10px 0;
    color: var(--text-muted);
    font-style: italic;
  }

  .msg-body hr {
    border: none;
    border-top: 1px solid var(--border);
    margin: 16px 0;
  }

  /* ===== COLLAPSIBLE SECTIONS ===== */
  .msg-section {
    margin: 10px 0;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    overflow: hidden;
  }

  .msg-section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 14px;
    background: var(--bg-tertiary);
    cursor: pointer;
    user-select: none;
    transition: background 0.15s;
  }

  .msg-section-header:hover {
    background: var(--bg-hover);
  }

  .msg-section-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--text);
  }

  .msg-section-toggle {
    font-size: 10px;
    color: var(--text-subtle);
    transition: transform 0.2s;
  }

  .msg-section.open .msg-section-toggle {
    transform: rotate(180deg);
  }

  .msg-section-body {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
  }

  .msg-section.open .msg-section-body {
    max-height: 2000px;
  }

  .msg-section-body-inner {
    padding: 10px 14px 14px;
    font-size: 13px;
    line-height: 1.6;
    color: var(--text-muted);
  }

  .msg-section-body-inner p { margin-bottom: 8px; }
  .msg-section-body-inner p:last-child { margin-bottom: 0; }
  .msg-section-body-inner strong { color: var(--text); }
  .msg-section-body-inner ul { padding-left: 18px; margin-bottom: 8px; }
  .msg-section-body-inner li { margin-bottom: 3px; }

  /* Summary line shown when collapsed */
  .msg-section-summary {
    padding: 0 14px 10px;
    font-size: 12px;
    color: var(--text-subtle);
    line-height: 1.5;
  }

  .msg-section.open .msg-section-summary {
    display: none;
  }

  /* Error message */
  .msg-error {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 12px 16px;
    background: rgba(248, 113, 113, 0.08);
    border: 1px solid rgba(248, 113, 113, 0.2);
    border-radius: var(--radius-sm);
    margin: 4px 0;
    animation: msgIn 0.3s ease-out;
  }

  .msg-error-icon {
    flex-shrink: 0;
    margin-top: 1px;
  }

  .msg-error-content {
    flex: 1;
  }

  .msg-error-text {
    font-size: 13px;
    color: var(--text-muted);
    line-height: 1.5;
    margin-bottom: 8px;
  }

  .msg-error-retry {
    font-size: 12px;
    font-weight: 500;
    color: var(--accent);
    background: none;
    border: 1px solid rgba(166, 124, 82, 0.3);
    border-radius: var(--radius-xs);
    padding: 4px 12px;
    cursor: pointer;
    font-family: inherit;
    transition: all 0.15s;
  }

  .msg-error-retry:hover {
    background: var(--accent-soft);
    border-color: var(--accent);
  }

  /* Deliverable notification */
  .deliverable-notice {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 14px;
    background: var(--green-soft);
    border: 1px solid rgba(52, 211, 153, 0.2);
    border-radius: var(--radius-xs);
    margin-top: 8px;
    font-size: 13px;
    color: var(--green);
    font-weight: 500;
  }

  .deliverable-notice svg {
    flex-shrink: 0;
  }

  /* ===== BRAND FOOTER ===== */
  .brand-footer {
    position: fixed;
    bottom: 8px;
    right: 16px;
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 10px;
    color: var(--text-subtle);
    opacity: 0.5;
    z-index: 5;
    pointer-events: none;
  }

  .brand-footer svg {
    width: 12px;
    height: 12px;
  }

  .brand-footer span {
    letter-spacing: 0.5px;
  }
  .beta-end-btn {
    margin-left: auto;
    padding: 3px 10px;
    border: 1px solid rgba(59, 130, 246, 0.2);
    border-radius: 10px;
    background: none;
    color: rgba(59, 130, 246, 0.5);
    font-size: 10px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .beta-end-btn:hover {
    border-color: rgba(59, 130, 246, 0.5);
    color: rgb(59, 130, 246);
    background: rgba(59, 130, 246, 0.05);
  }

  /* ===== RESPONSIVE ===== */
  @media (max-width: 900px) {
    .preview-panel { display: none; }
    .chat-panel { border-right: none; }
  }
</style>
</head>
<body>

<!-- SETUP MODAL -->
<div class="setup-overlay" id="setupOverlay">
  <div class="setup-modal">
    <div style="display:flex; align-items:center; gap:10px; margin-bottom:16px;">
      <div class="logo-mark">
        <svg viewBox="0 0 100 100" fill="none">
          <path d="M50 5C50 5 25 20 20 45C15 70 30 90 50 95C70 90 85 70 80 45C75 20 50 5 50 5Z" fill="white"/>
          <path d="M50 15V85" stroke="#A67C52" stroke-width="2" opacity="0.3"/>
          <path d="M50 30C40 40 35 55 38 70" stroke="#A67C52" stroke-width="1.5" opacity="0.2"/>
          <path d="M50 30C60 40 65 55 62 70" stroke="#A67C52" stroke-width="1.5" opacity="0.2"/>
          <circle cx="50" cy="25" r="5" fill="#C41E3A"/>
        </svg>
      </div>
      <span class="logo-text">Fig<span>Studio</span></span>
    </div>
    <h2>Welcome</h2>
    <p class="setup-subtitle">FigStudio helps you build, refine, and sell digital products. Tell me your name and let's get to work.</p>
    <div class="setup-field">
      <label>Your name</label>
      <input type="text" id="userNameInput" placeholder="Your name" autocomplete="off" autofocus>
    </div>
    <button class="setup-start" id="setupStart" onclick="startSession()">Start</button>
    <div class="setup-note">Private beta &middot; FigStudio by FigSamurai</div>
  </div>
</div>

<!-- TOP BAR -->
<div class="topbar">
  <div class="topbar-left">
    <div class="logo-mark">
      <svg viewBox="0 0 100 100" fill="none">
        <path d="M50 5C50 5 25 20 20 45C15 70 30 90 50 95C70 90 85 70 80 45C75 20 50 5 50 5Z" fill="white"/>
        <path d="M50 15V85" stroke="#A67C52" stroke-width="2" opacity="0.3"/>
        <path d="M50 30C40 40 35 55 38 70" stroke="#A67C52" stroke-width="1.5" opacity="0.2"/>
        <path d="M50 30C60 40 65 55 62 70" stroke="#A67C52" stroke-width="1.5" opacity="0.2"/>
        <circle cx="50" cy="25" r="5" fill="#C41E3A"/>
      </svg>
    </div>
    <span class="logo-text">Fig<span>Studio</span></span>
    <div class="topbar-status">
      <span class="status-dot"></span>
      Online
    </div>
  </div>
  <div class="topbar-right">
    <button class="topbar-btn" id="previewToggle" onclick="togglePreview()">Preview</button>
    <button class="topbar-btn" onclick="exportPDF()">Export PDF</button>
  </div>
</div>

<!-- MAIN -->
<div class="main">
  <!-- CHAT -->
  <div class="chat-panel">
    <div class="chat-messages" id="chatMessages"></div>
    <div class="input-area">
      <button class="stop-btn" id="stopBtn" onclick="stopGeneration()">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><rect x="4" y="4" width="16" height="16" rx="2"></rect></svg>
        Stop
      </button>
      <div class="input-box">
        <textarea id="userInput" rows="1" placeholder="Tell me what you need..." oninput="autoResize(this)" onkeydown="handleKey(event)"></textarea>
        <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </div>
      <div class="input-meta">
        <span class="input-hint">Enter to send &middot; Shift+Enter for new line</span>
        <div class="mode-indicator">
          <button class="mode-pill" onclick="setMode('quick', this)" title="Fast and direct ‚Äî get it done">Quick</button>
          <button class="mode-pill active" onclick="setMode('guided', this)" title="Step by step, with your input">Guided</button>
          <button class="mode-pill" onclick="setMode('thorough', this)" title="Deep analysis, every detail">Thorough</button>
        </div>
      </div>
    </div>
  </div>

  <!-- PREVIEW -->
  <div class="preview-panel" id="previewPanel">
    <div class="preview-header">
      <div class="preview-header-left">
        <span class="preview-title">Preview</span>
        <div class="preview-version" id="previewVersion" style="display:none;">
          <button class="preview-version-btn" id="prevVersionBtn" onclick="showVersion(-1)" disabled title="Previous version">‚óÄ</button>
          <span class="preview-version-label" id="versionLabel">v1/1</span>
          <button class="preview-version-btn" id="nextVersionBtn" onclick="showVersion(1)" disabled title="Next version">‚ñ∂</button>
        </div>
      </div>
      <div class="preview-actions">
        <button class="topbar-btn" onclick="exportPDF()">Download PDF</button>
      </div>
    </div>
    <div class="preview-body">
      <div class="preview-empty" id="previewEmpty">
        <div class="preview-empty-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--text-subtle)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
          </svg>
        </div>
        <h3>No deliverable yet</h3>
        <p>Your documents will appear here as we work together.</p>
      </div>
      <iframe class="preview-iframe" id="previewIframe"></iframe>
    </div>
  </div>
</div>

<script>
// ===== STATE =====
let USER_NAME = '';
let conversationHistory = [];
let systemPrompt = '';
let currentMode = 'guided';
let isStreaming = false;
let deliverableHistory = [];  // Array of HTML strings
let currentVersionIndex = -1; // -1 = no deliverables yet
let userMessageCount = 0;     // Track user messages for mode discovery hint
let modeHintShown = false;    // Only show the mode discovery hint once

// ===== BETA TESTING INFRASTRUCTURE =====
const BETA_TESTING = true; // Toggle off for production

const betaSession = {
  id: 'beta-' + Date.now(),
  startTime: null,
  userName: '',
  events: [],        // Timestamped event log
  pulseResponses: [], // Micro-question answers
  modeChanges: [],   // Mode switch log
  messageTimings: [], // Time between messages
  lastMessageTime: null,
  featuresUsed: new Set(), // copy, stop, preview, mode-change, version-nav
  deliverableCount: 0,
  urlsFetched: [],
  fetchErrors: [],

  // === CONVERSATION CONTENT ANALYSIS ===
  conversationInsights: {
    userIntents: [],         // What the user wanted at each message
    repeatedAsks: [],        // Things the user had to ask more than once
    frustrationSignals: [],  // Messages showing confusion, frustration, repetition
    delightSignals: [],      // Messages showing satisfaction, excitement, surprise
    wowMoments: [],          // When FigStudio delivered unexpected value
    missionDetected: null,   // Create / Refine / Rebuild / etc.
    topicFlow: [],           // Topic progression through conversation
    unansweredNeeds: [],     // Things user asked that weren't addressed
    valueDelivered: [],      // Concrete things FigStudio produced or taught
    aiIssues: [],            // Hallucinations, wrong tone, preamble leaks, etc.
  },

  pulseSchedule: [
    { trigger: 'message_3', question: 'How natural does this conversation feel so far?', options: ['Very natural', 'Mostly natural', 'A bit robotic', 'Unnatural'] },
    { trigger: 'after_analysis', question: 'Was the website analysis useful?', options: ['Very useful', 'Somewhat useful', 'Not very useful', 'Confusing'] },
    { trigger: 'after_deliverable', question: 'How does this deliverable look?', options: ['Impressive', 'Good enough', 'Needs work', 'Not what I expected'] },
    { trigger: 'message_8', question: 'Is FigStudio helping you move forward?', options: ['Definitely', 'Somewhat', 'Not really', 'I\'m stuck'] },
    { trigger: 'end_session', question: 'Would you use FigStudio again for a real project?', options: ['Yes, definitely', 'Probably', 'Maybe', 'No'] }
  ],
  pulsesShown: new Set()
};

// ===== CONVERSATION CONTENT ANALYZER =====
// Analyzes WHAT users say, not just HOW they interact

function analyzeUserMessage(text, messageNum) {
  if (!BETA_TESTING) return;
  const lower = text.toLowerCase();
  const insights = betaSession.conversationInsights;

  // --- INTENT DETECTION ---
  const intent = detectIntent(lower, text);
  insights.userIntents.push({ message: messageNum, intent, text: text.substring(0, 200) });

  // --- MISSION DETECTION (first few messages) ---
  if (messageNum <= 3 && !insights.missionDetected) {
    if (/(?:crear|create|build|nueva|new|from scratch|desde cero)/i.test(text)) insights.missionDetected = 'Create';
    else if (/(?:update|actualizar|mejorar|improve|refine|fix|arreglar|change)/i.test(text)) insights.missionDetected = 'Refine';
    else if (/(?:rebuild|redesign|redise√±ar|overhaul|redo)/i.test(text)) insights.missionDetected = 'Rebuild';
    else if (/(?:launch|lanzar|market|promocionar|sell)/i.test(text)) insights.missionDetected = 'Launch';
  }

  // --- TOPIC TRACKING ---
  const topic = detectTopic(lower);
  if (topic) insights.topicFlow.push({ message: messageNum, topic });

  // --- FRUSTRATION SIGNALS ---
  const frustration = detectFrustration(lower, text, messageNum);
  if (frustration) insights.frustrationSignals.push(frustration);

  // --- DELIGHT SIGNALS ---
  const delight = detectDelight(lower, text, messageNum);
  if (delight) insights.delightSignals.push(delight);

  // --- REPEATED ASK DETECTION ---
  detectRepeatedAsk(lower, text, messageNum, insights);
}

function analyzeAssistantResponse(text, messageNum) {
  if (!BETA_TESTING) return;
  const lower = text.toLowerCase();
  const insights = betaSession.conversationInsights;

  // --- VALUE DELIVERY TRACKING ---
  const value = detectValueDelivered(lower, text, messageNum);
  if (value.length > 0) insights.valueDelivered.push(...value);

  // --- AI ISSUE DETECTION ---
  const issues = detectAiIssues(lower, text, messageNum);
  if (issues.length > 0) insights.aiIssues.push(...issues);

  // --- WOW MOMENT DETECTION ---
  // A wow moment is when the AI surfaces something the user didn't ask for
  if (/(?:you might not have noticed|you hadn't thought|bonus|by the way|also noticed|opportunity|missed opportunity|oportunidad)/i.test(text)) {
    insights.wowMoments.push({ message: messageNum, type: 'unsolicited_insight', snippet: text.substring(0, 150) });
  }
}

function detectIntent(lower, text) {
  if (/https?:\/\//.test(text)) return 'shared_url';
  if (/(?:what (?:do i|should i|can i)|qu√© (?:hago|necesito|puedo)|how (?:do i|does)|c√≥mo)/i.test(text)) return 'asking_how';
  if (/(?:show me|mu√©strame|mockup|preview|dise√±o|design|visual)/i.test(text)) return 'wants_visual';
  if (/(?:document|documento|proposal|propuesta|one-?pager|pdf)/i.test(text)) return 'wants_deliverable';
  if (/(?:price|precio|cost|cu√°nto|how much|cobrar|charge|budget|presupuesto)/i.test(text)) return 'asking_price';
  if (/(?:client|cliente|told me|me dijo|asked me|me pidi√≥)/i.test(text)) return 'sharing_client_context';
  if (/(?:no|wrong|incorrect|that's not|eso no|mal|error|fake|inventado)/i.test(text)) return 'correcting_ai';
  if (/(?:yes|s√≠|si|perfect|perfecto|great|genial|exactly|exacto|good|bien|ok|vale)/i.test(text) && text.length < 50) return 'confirming';
  if (/(?:change|cambiar|modify|modificar|adjust|ajustar|different|diferente|otro|another)/i.test(text)) return 'requesting_change';
  if (/(?:help|ayuda|stuck|atascado|confused|no entiendo|don't understand)/i.test(text)) return 'asking_help';
  if (/(?:who|qui√©n|about|sobre|what is|qu√© es)/i.test(text) && text.length < 80) return 'asking_info';
  return 'general';
}

function detectTopic(lower) {
  if (/(?:seo|google|ranking|position|b√∫squeda|search)/.test(lower)) return 'SEO';
  if (/(?:design|dise√±o|color|font|layout|visual|look|aspecto)/.test(lower)) return 'design';
  if (/(?:content|contenido|copy|text|texto|message|mensaje)/.test(lower)) return 'content';
  if (/(?:mobile|m√≥vil|responsive|phone|celular)/.test(lower)) return 'mobile';
  if (/(?:price|precio|cost|cu√°nto|budget|presupuesto|money|dinero)/.test(lower)) return 'pricing';
  if (/(?:competitor|competencia|competition|rival)/.test(lower)) return 'competition';
  if (/(?:google business|google maps|rese√±as|reviews|rating)/.test(lower)) return 'local_seo';
  if (/(?:blog|article|art√≠culo|post|noticias|news)/.test(lower)) return 'blog';
  if (/(?:photo|foto|image|imagen|video|gallery|galer√≠a)/.test(lower)) return 'media';
  if (/(?:mockup|prototype|prototipo|preview|demo)/.test(lower)) return 'mockup';
  if (/(?:document|documento|proposal|propuesta|pitch|presentation)/.test(lower)) return 'deliverable';
  return null;
}

function detectFrustration(lower, text, messageNum) {
  // Explicit frustration
  if (/(?:no(?:,| )|that's wrong|eso no|mal|incorrect|nope|not what|no es lo que)/i.test(text)) {
    return { message: messageNum, type: 'correction', text: text.substring(0, 150) };
  }
  // Repetition (short message that repeats a previous intent)
  if (text.length < 30 && /(?:\?|por favor|please|again|otra vez|de nuevo)/i.test(text)) {
    return { message: messageNum, type: 'repeating_request', text: text.substring(0, 150) };
  }
  // Question marks in short messages (confusion)
  if (text.length < 40 && (text.match(/\?/g) || []).length >= 1 && !/https?:\/\//.test(text)) {
    return { message: messageNum, type: 'confusion', text: text.substring(0, 150) };
  }
  return null;
}

function detectDelight(lower, text, messageNum) {
  if (/(?:wow|amazing|incre√≠ble|genial|perfect|perfecto|love it|me encanta|impressive|great|awesome|excellent|excelente|brutal|fant√°stico)/i.test(text)) {
    return { message: messageNum, type: 'explicit_delight', text: text.substring(0, 150) };
  }
  if (/(?:exactly|exacto|that's it|eso es|this is what|justo lo que|nailed it)/i.test(text)) {
    return { message: messageNum, type: 'validation', text: text.substring(0, 150) };
  }
  // Long enthusiastic follow-up (user engaged deeply)
  if (text.length > 200 && !/(?:no |wrong|mal |error)/i.test(text)) {
    return { message: messageNum, type: 'deep_engagement', text: text.substring(0, 150) };
  }
  return null;
}

function detectRepeatedAsk(lower, text, messageNum, insights) {
  // Compare intent with previous intents
  const currentIntent = detectIntent(lower, text);
  const previousSameIntent = insights.userIntents.filter(i => i.intent === currentIntent && i.message < messageNum);
  if (previousSameIntent.length > 0 && currentIntent !== 'general' && currentIntent !== 'confirming') {
    insights.repeatedAsks.push({
      message: messageNum,
      intent: currentIntent,
      previousMessage: previousSameIntent[previousSameIntent.length - 1].message,
      text: text.substring(0, 150)
    });
  }
}

function detectValueDelivered(lower, text, messageNum) {
  const values = [];
  if (/```html-deliverable/.test(text)) values.push({ message: messageNum, type: 'deliverable_created' });
  if (/(?:## |section|diagnos|analysis|an√°lisis)/i.test(text) && text.length > 500) values.push({ message: messageNum, type: 'deep_analysis' });
  if (/(?:portfolio|caso de estudio|case study)/i.test(text)) values.push({ message: messageNum, type: 'portfolio_advice' });
  if (/(?:price|precio|‚Ç¨|eur|cobrar|charge|quote|presupuesto)/i.test(text) && text.length > 100) values.push({ message: messageNum, type: 'pricing_guidance' });
  if (/(?:google business|google maps|local seo)/i.test(text)) values.push({ message: messageNum, type: 'local_seo_advice' });
  if (/(?:competitor|competencia|competition)/i.test(text) && text.length > 200) values.push({ message: messageNum, type: 'competitive_analysis' });
  if (/(?:mockup|dise√±o|redesign|redise√±o)/i.test(text) && /```html-deliverable/.test(text)) values.push({ message: messageNum, type: 'visual_mockup' });
  return values;
}

function detectAiIssues(lower, text, messageNum) {
  const issues = [];
  // Preamble detection
  if (/^(?:i'd be happy|i'll analyze|let me (?:take a look|analyze)|voy a analizar|d√©jame ver)/i.test(text.trim())) {
    issues.push({ message: messageNum, type: 'preamble_leak', snippet: text.substring(0, 80) });
  }
  // Web fetch tag leak
  if (/<web_fetch>|<\/web_fetch>/i.test(text)) {
    issues.push({ message: messageNum, type: 'web_fetch_tag_leak' });
  }
  // Menu/list dump in early conversation (first 3 assistant messages)
  if (messageNum <= 6 && (text.match(/^- /gm) || []).length > 4) {
    issues.push({ message: messageNum, type: 'early_bullet_dump', bulletCount: (text.match(/^- /gm) || []).length });
  }
  // Possible name hallucination: AI mentions Dr./Dra. names not present in tool data
  if (/(?:Dr\.?|Dra\.?)\s+[A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±]+/i.test(text)) {
    issues.push({ message: messageNum, type: 'possible_name_mention', snippet: text.match(/(?:Dr\.?|Dra\.?)\s+[A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±]+(?:\s+[A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±]+){0,2}/i)?.[0] || '' });
  }
  // Overly long early response
  if (messageNum <= 4 && text.length > 800 && !/```html-deliverable/.test(text)) {
    issues.push({ message: messageNum, type: 'early_response_too_long', length: text.length });
  }
  return issues;
}

function betaLog(eventType, data = {}) {
  if (!BETA_TESTING) return;
  const event = {
    type: eventType,
    timestamp: new Date().toISOString(),
    elapsed: betaSession.startTime ? Date.now() - betaSession.startTime : 0,
    ...data
  };
  betaSession.events.push(event);
}

function betaTrackTiming() {
  if (!BETA_TESTING) return;
  const now = Date.now();
  if (betaSession.lastMessageTime) {
    const gap = now - betaSession.lastMessageTime;
    betaSession.messageTimings.push({
      gap,
      afterMessage: userMessageCount,
      timestamp: new Date().toISOString()
    });
  }
  betaSession.lastMessageTime = now;
}

function betaTrackFeature(feature) {
  if (!BETA_TESTING) return;
  betaSession.featuresUsed.add(feature);
  betaLog('feature_used', { feature });
}

function betaCheckPulse(trigger) {
  if (!BETA_TESTING) return;
  if (betaSession.pulsesShown.has(trigger)) return;

  const pulse = betaSession.pulseSchedule.find(p => p.trigger === trigger);
  if (!pulse) return;

  betaSession.pulsesShown.add(trigger);

  // Delay pulse slightly so it doesn't interrupt the flow
  setTimeout(() => showBetaPulse(pulse), 2000);
}

function showBetaPulse(pulse) {
  const container = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = 'beta-pulse';
  div.id = 'betaPulse-' + Date.now();

  const optionsHtml = pulse.options.map((opt, i) =>
    `<button class="beta-pulse-option" onclick="answerBetaPulse('${div.id}', '${pulse.trigger}', '${opt.replace(/'/g, "\\'")}', this)">${opt}</button>`
  ).join('');

  div.innerHTML = `
    <div class="beta-pulse-content">
      <div class="beta-pulse-badge">Beta feedback</div>
      <div class="beta-pulse-question">${pulse.question}</div>
      <div class="beta-pulse-options">${optionsHtml}</div>
      <textarea class="beta-pulse-comment" placeholder="Any additional thoughts? (optional)" rows="1" onfocus="this.rows=2" onblur="if(!this.value)this.rows=1"></textarea>
    </div>
  `;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

function answerBetaPulse(divId, trigger, answer, btn) {
  const div = document.getElementById(divId);
  const comment = div.querySelector('.beta-pulse-comment')?.value || '';

  betaSession.pulseResponses.push({
    trigger,
    answer,
    comment,
    timestamp: new Date().toISOString(),
    messageCount: userMessageCount
  });
  betaLog('pulse_response', { trigger, answer, comment });

  // Visual feedback
  div.querySelectorAll('.beta-pulse-option').forEach(b => b.disabled = true);
  btn.classList.add('selected');
  div.querySelector('.beta-pulse-question').textContent = 'Thanks! üôè';
  div.querySelector('.beta-pulse-comment').style.display = 'none';
  div.querySelector('.beta-pulse-options').style.opacity = '0.5';

  // Fade out after 2s
  setTimeout(() => {
    div.style.opacity = '0';
    div.style.transform = 'translateY(-8px)';
    setTimeout(() => div.remove(), 300);
  }, 2000);
}

function generateBetaReport() {
  if (!BETA_TESTING) return null;

  const duration = Date.now() - betaSession.startTime;
  const avgTiming = betaSession.messageTimings.length > 0
    ? betaSession.messageTimings.reduce((s, t) => s + t.gap, 0) / betaSession.messageTimings.length
    : 0;

  // Build conversation content analysis summary
  const ci = betaSession.conversationInsights;
  const intentSummary = {};
  ci.userIntents.forEach(i => { intentSummary[i.intent] = (intentSummary[i.intent] || 0) + 1; });

  const report = {
    sessionId: betaSession.id,
    userName: betaSession.userName,
    duration: Math.round(duration / 1000),
    durationReadable: formatDuration(duration),
    totalMessages: userMessageCount,
    deliverableCount: betaSession.deliverableCount,
    urlsFetched: betaSession.urlsFetched,
    fetchErrors: betaSession.fetchErrors,
    modeChanges: betaSession.modeChanges,
    finalMode: currentMode,
    featuresUsed: [...betaSession.featuresUsed],
    averageResponseTime: Math.round(avgTiming / 1000) + 's',
    messageTimings: betaSession.messageTimings,
    pulseResponses: betaSession.pulseResponses,

    // === CONVERSATION CONTENT ANALYSIS ===
    conversationAnalysis: {
      missionDetected: ci.missionDetected,
      intentBreakdown: intentSummary,
      topicFlow: ci.topicFlow,
      repeatedAsks: ci.repeatedAsks,
      frustrationSignals: ci.frustrationSignals,
      delightSignals: ci.delightSignals,
      wowMoments: ci.wowMoments,
      valueDelivered: ci.valueDelivered,
      aiIssues: ci.aiIssues,
      // High-level summary flags
      userHadToCorrectAI: ci.frustrationSignals.some(f => f.type === 'correction'),
      userRepeatedRequests: ci.repeatedAsks.length > 0,
      userExpressedDelight: ci.delightSignals.length > 0,
      aiHallucinationRisk: ci.aiIssues.some(i => i.type === 'possible_name_mention'),
      aiPreambleLeaked: ci.aiIssues.some(i => i.type === 'preamble_leak'),
      topicsExplored: [...new Set(ci.topicFlow.map(t => t.topic))],
      valueTypes: [...new Set(ci.valueDelivered.map(v => v.type))],
    },

    // === FULL CONVERSATION TRANSCRIPT ===
    conversation: conversationHistory.map((msg, i) => ({
      role: msg.role,
      content: msg.content.substring(0, 2000), // Truncate very long messages
      messageIndex: i
    })),

    eventLog: betaSession.events,
    conversationLength: conversationHistory.length,
    timestamp: new Date().toISOString()
  };

  return report;
}

function formatDuration(ms) {
  const m = Math.floor(ms / 60000);
  const s = Math.floor((ms % 60000) / 1000);
  return `${m}m ${s}s`;
}

function exportBetaReport() {
  const report = generateBetaReport();
  if (!report) return;

  const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `figstudio-beta-${betaSession.id}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

function showBetaReport() {
  const report = generateBetaReport();
  if (!report) return;

  // Check for end-of-session pulse first
  betaCheckPulse('end_session');

  // Show report after a short delay for the pulse
  setTimeout(() => {
    const container = document.getElementById('chatMessages');
    const div = document.createElement('div');
    div.className = 'beta-report';
    const ca = report.conversationAnalysis;
    const flagsHtml = [
      ca.missionDetected ? `<span class="beta-flag">Mission: ${ca.missionDetected}</span>` : '',
      ca.userExpressedDelight ? '<span class="beta-flag beta-flag-good">üòä User delighted</span>' : '',
      ca.userHadToCorrectAI ? '<span class="beta-flag beta-flag-bad">‚ö†Ô∏è User corrected AI</span>' : '',
      ca.userRepeatedRequests ? '<span class="beta-flag beta-flag-bad">üîÅ Repeated asks</span>' : '',
      ca.aiHallucinationRisk ? '<span class="beta-flag beta-flag-bad">üë§ Name mention (check)</span>' : '',
      ca.aiPreambleLeaked ? '<span class="beta-flag beta-flag-bad">üí¨ Preamble leaked</span>' : '',
    ].filter(Boolean).join(' ');

    div.innerHTML = `
      <div class="beta-report-content">
        <div class="beta-report-title">üìä Beta Session Report</div>
        <div class="beta-report-stats">
          <div class="beta-stat"><span class="beta-stat-value">${report.durationReadable}</span><span class="beta-stat-label">Duration</span></div>
          <div class="beta-stat"><span class="beta-stat-value">${report.totalMessages}</span><span class="beta-stat-label">Messages</span></div>
          <div class="beta-stat"><span class="beta-stat-value">${report.deliverableCount}</span><span class="beta-stat-label">Deliverables</span></div>
          <div class="beta-stat"><span class="beta-stat-value">${report.averageResponseTime}</span><span class="beta-stat-label">Avg gap</span></div>
          <div class="beta-stat"><span class="beta-stat-value">${ca.topicsExplored.length}</span><span class="beta-stat-label">Topics</span></div>
          <div class="beta-stat"><span class="beta-stat-value">${ca.valueTypes.length}</span><span class="beta-stat-label">Value types</span></div>
        </div>

        <div class="beta-report-section">
          <strong>Session flags:</strong>
          <div class="beta-flags">${flagsHtml || '<span class="beta-flag">Clean session</span>'}</div>
        </div>

        ${ca.topicsExplored.length > 0 ? `
        <div class="beta-report-section">
          <strong>Topics explored:</strong> ${ca.topicsExplored.join(' ‚Üí ')}
        </div>` : ''}

        ${ca.valueTypes.length > 0 ? `
        <div class="beta-report-section">
          <strong>Value delivered:</strong> ${ca.valueTypes.map(v => v.replace(/_/g, ' ')).join(', ')}
        </div>` : ''}

        ${ca.frustrationSignals.length > 0 ? `
        <div class="beta-report-section">
          <strong>‚ö†Ô∏è Friction points:</strong>
          ${ca.frustrationSignals.map(f => `<div class="beta-feedback-item">[msg ${f.message}] ${f.type}: "${f.text}"</div>`).join('')}
        </div>` : ''}

        ${ca.delightSignals.length > 0 ? `
        <div class="beta-report-section">
          <strong>üòä Delight moments:</strong>
          ${ca.delightSignals.map(d => `<div class="beta-feedback-item">[msg ${d.message}] ${d.type}: "${d.text}"</div>`).join('')}
        </div>` : ''}

        ${ca.repeatedAsks.length > 0 ? `
        <div class="beta-report-section">
          <strong>üîÅ Repeated asks (user had to ask again):</strong>
          ${ca.repeatedAsks.map(r => `<div class="beta-feedback-item">[msg ${r.message}] ${r.intent} (first asked at msg ${r.previousMessage})</div>`).join('')}
        </div>` : ''}

        ${ca.aiIssues.length > 0 ? `
        <div class="beta-report-section">
          <strong>üêõ AI issues detected:</strong>
          ${ca.aiIssues.map(i => `<div class="beta-feedback-item">[msg ${i.message}] ${i.type}${i.snippet ? `: "${i.snippet}"` : ''}</div>`).join('')}
        </div>` : ''}

        ${report.pulseResponses.length > 0 ? `
        <div class="beta-report-section">
          <strong>User feedback:</strong>
          ${report.pulseResponses.map(p => `<div class="beta-feedback-item">"${p.answer}" ‚Äî ${p.trigger}${p.comment ? ` (${p.comment})` : ''}</div>`).join('')}
        </div>` : ''}

        <div class="beta-report-actions">
          <button class="beta-report-btn" onclick="exportBetaReport()">üì• Export this session</button>
          <button class="beta-report-btn" onclick="navigator.clipboard.writeText(JSON.stringify(generateBetaReport(), null, 2)).then(() => this.textContent = 'Copied!')">üìã Copy to clipboard</button>
          <button class="beta-report-btn" onclick="exportAllBetaSessions()">üì¶ Export all sessions (${getAllBetaSessions().length})</button>
        </div>
        <div class="beta-report-section" style="margin-top:8px; font-size:11px; opacity:0.6;">
          Auto-saved to browser. ${getAllBetaSessions().length} session(s) stored. Data persists across sessions.
        </div>
      </div>
    `;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
  }, betaSession.pulsesShown.has('end_session') ? 0 : 3000);
}

// ===== AUTO-SAVE (never lose beta data) =====
let betaAutoSaveInterval = null;

function betaAutoSave() {
  if (!BETA_TESTING || !betaSession.startTime) return;
  try {
    const report = generateBetaReport();
    if (!report) return;
    // Save to localStorage with session ID as key
    localStorage.setItem(`figstudio-beta-${betaSession.id}`, JSON.stringify(report));
    // Also maintain an index of all sessions
    const sessions = JSON.parse(localStorage.getItem('figstudio-beta-sessions') || '[]');
    const existing = sessions.findIndex(s => s.id === betaSession.id);
    const entry = {
      id: betaSession.id,
      userName: betaSession.userName,
      timestamp: new Date().toISOString(),
      messageCount: userMessageCount,
      duration: Math.round((Date.now() - betaSession.startTime) / 1000)
    };
    if (existing >= 0) sessions[existing] = entry;
    else sessions.push(entry);
    localStorage.setItem('figstudio-beta-sessions', JSON.stringify(sessions));
  } catch(e) {
    // localStorage full or unavailable ‚Äî silent fail
  }
}

function startBetaAutoSave() {
  if (!BETA_TESTING) return;
  // Save every 30 seconds
  betaAutoSaveInterval = setInterval(betaAutoSave, 30000);

  // Save when page becomes hidden (user switches tab or minimizes)
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) betaAutoSave();
  });

  // Save on page close/navigate
  window.addEventListener('beforeunload', () => {
    betaAutoSave();
  });

  // Save on any page unload event (mobile browsers)
  window.addEventListener('pagehide', () => {
    betaAutoSave();
  });
}

// Function to retrieve all saved beta sessions (for analysis)
function getAllBetaSessions() {
  const sessions = JSON.parse(localStorage.getItem('figstudio-beta-sessions') || '[]');
  return sessions.map(s => {
    const data = JSON.parse(localStorage.getItem(`figstudio-beta-${s.id}`) || 'null');
    return { ...s, data };
  }).filter(s => s.data);
}

// Function to export ALL saved sessions as a single JSON
function exportAllBetaSessions() {
  const allSessions = getAllBetaSessions();
  const blob = new Blob([JSON.stringify(allSessions, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `figstudio-beta-all-sessions-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

// ===== SETUP =====
async function startSession() {
  const name = document.getElementById('userNameInput').value.trim();
  if (!name) return;

  USER_NAME = name;
  betaSession.startTime = Date.now();
  betaSession.userName = name;
  betaLog('session_start', { userName: name });
  startBetaAutoSave();

  document.getElementById('setupOverlay').style.display = 'none';

  // Load system prompt
  try {
    const resp = await fetch('system-prompt.md');
    systemPrompt = await resp.text();
  } catch(e) {
    systemPrompt = 'You are FigStudio Advisor, an AI-guided platform for building digital products.';
  }

  // Replace placeholder with real name
  systemPrompt = systemPrompt.replace(/\[USER NAME\]/g, USER_NAME);

  // Add context about available tools and capabilities
  systemPrompt += `\n\n## Tools available in this session\n\nWhen the user shares a website URL, the FigStudio platform AUTOMATICALLY fetches the page and provides you with structured data (tech stack, mobile analysis, content, SEO signals, etc.) in a tool result message. You do NOT need to call any tool or announce what you're doing ‚Äî the fetch happens behind the scenes. Never output tags like <web_fetch> or similar ‚Äî you don't have tools to call. The data just appears.\n\nIMPORTANT: When you receive website data, go straight into analysis. Do NOT say "I'll analyze this" or "Let me take a look" ‚Äî the user already sees a loading indicator while the site is being fetched. By the time they read your response, they expect the analysis, not an announcement.

If the fetch FAILS (you'll receive a tool result saying it failed), don't panic. Tell the user the site couldn't be loaded, ask them to double-check the URL, and keep the conversation moving. You can still ask useful questions about the business, the client, the goals ‚Äî and be ready to analyze when the correct URL arrives. Never pretend you analyzed a site you couldn't access.\n\nThe user's name is: ${USER_NAME}\n\n## Generating visual output\n\nYou can generate TWO types of visual output that render live in the Preview panel:\n\n### 1. Deliverables (documents for the client)\nOne-pagers, full documents, email pitches, slide decks. Output the COMPLETE HTML inside a code block with the language tag \`\`\`html-deliverable. Requirements:\n- Self-contained with all CSS inline or in a <style> block\n- Use A4 dimensions (210mm x 297mm) for print-ready documents\n- Print-ready CSS (@page, print-color-adjust)\n- Import fonts from Google Fonts CDN\n- The deliverable must be COMPLETE and BEAUTIFUL ‚Äî this is the user's output for their client\n- Include the attribution line at the bottom in the user's language: "Preparado por ${USER_NAME} ¬∑ Powered by FigStudio" (Spanish) or "Prepared by ${USER_NAME} ¬∑ Powered by FigStudio" (English)\n\n### 2. Website mockups (visual design previews)\nWhen the user wants to see what the new or improved website could look like, generate a FULL HTML page that serves as a visual mockup. Use the same \`\`\`html-deliverable code block ‚Äî the Preview panel will render it identically.\n\nFor website mockups:\n- Build a complete, realistic-looking page ‚Äî not a wireframe. It should look like a real website.\n- Use modern design patterns, clean typography, good spacing\n- Include placeholder content that matches the client's actual business (real service names, realistic copy, appropriate imagery via placeholder services or CSS gradients/shapes)\n- Make it responsive-looking within the preview\n- Use the client's actual brand colors if known, or propose a professional palette\n- Include all key sections: hero, services, reviews/trust signals, contact, footer\n- The user can ask for different styles, variations, or specific changes ‚Äî each new version replaces the previous one in Preview\n- This is NOT the final website ‚Äî it's a visual concept to help the user and their client align on direction before building\n\nThe mockup capability is powerful: the user can say "show me what the new homepage could look like" and you produce a complete visual design in seconds. They can then iterate: "make it more modern", "try a different color scheme", "add a reviews section." Each iteration renders live.`;

  // Reinforce conversation rules at the end (recency bias ‚Äî model weighs end of prompt heavily)
  systemPrompt += `\n\n## REMEMBER ‚Äî conversation rules (non-negotiable)\n\n- Your early responses must be 1-2 sentences. No bullet lists, no roadmaps, no previewing what you'll do.\n- If the user already told you what they need, don't repeat it back. Just ask for the ONE thing you're missing (usually: the URL).\n- BAD: "I'd be happy to help! I'll analyze design, SEO, content, performance..." ‚Üí This is filler. Stop.\n- GOOD: "Sure ‚Äî drop me the URL and I'll take a look right now." ‚Üí This is FigStudio.\n- The depth comes AFTER you have data, not before.\n- NEVER INVENT NAMES. Do not generate doctor names, owner names, staff names, or any person's name unless it appears verbatim in the tool data or the user told you. Use "the clinic", "the business", "the owner" instead. This is a trust-destroying error ‚Äî the user will show this to their client.\n- After a diagnosis, ALWAYS do BOTH: (1) show what you can build next ‚Äî mockup, document, redesign, quick wins ‚Äî so the user knows what's possible, and (2) ask ONE practical context question ‚Äî what did the client say, do they have a Google profile, who's the competition. Never do only one. Both, every time.
- Never say "I'll analyze this" or "Let me take a look" ‚Äî the user already saw a loading indicator. Go straight into findings.
- Bullet lists are fine for diagnosis findings ‚Äî keep them short and specific. The "no bullet lists" rule is for EARLY responses before you have data, not for analysis results.
- Calibrate your explanations to the user's demonstrated knowledge. If they say "I'm a designer", don't explain visual concepts ‚Äî explain web-specific things through visual analogies. If they're technical, match their depth. Don't over-explain what they know or under-explain what they don't.
- If a business name contains a person's name (e.g., "La Tasca de Pepe"), do NOT call the owner by that name until the user confirms who runs the business.
- Attribution language matches the user: "Preparado por" in Spanish, "Prepared by" in English.`;

  // Add mode behavior instructions
  systemPrompt += getModeInstructions();

  // Opening message ‚Äî Refine-first, concrete, value-forward
  addMessage('assistant', getOpeningMessage());
  document.getElementById('userInput').focus();
}

function getOpeningMessage() {
  return `Hey ${USER_NAME} ‚Äî what do you need?`;
}

// ===== MESSAGES =====
function addMessage(role, content) {
  const container = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = `msg msg-${role}`;

  if (role === 'assistant') {
    div.innerHTML = `
      <div class="msg-label">
        <svg width="14" height="14" viewBox="0 0 100 100" fill="none">
          <path d="M50 5C50 5 25 20 20 45C15 70 30 90 50 95C70 90 85 70 80 45C75 20 50 5 50 5Z" fill="currentColor" opacity="0.7"/>
          <circle cx="50" cy="25" r="5" fill="#C41E3A"/>
        </svg>
        FigStudio
      </div>
      <div class="msg-body">${renderMarkdown(content)}</div>
      <div class="msg-actions">
        <button class="msg-action-btn" onclick="copyMessage(this)">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
          Copy
        </button>
      </div>
    `;
    // Store raw text for copy
    div.dataset.rawContent = content;
  } else {
    div.innerHTML = `<div class="msg-body">${escapeHtml(content)}</div>`;
  }

  container.appendChild(div);
  container.scrollTop = container.scrollHeight;

  // Check for deliverable HTML in the response
  if (role === 'assistant') {
    checkForDeliverable(content);
  }

  return div;
}

function showModeHint() {
  const container = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = 'mode-hint';
  div.id = 'modeHint';

  const modeNames = { quick: 'Quick', guided: 'Guided', thorough: 'Thorough' };
  const currentName = modeNames[currentMode] || 'Guided';

  div.innerHTML = `
    <div class="mode-hint-content">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="16" x2="12" y2="12"></line>
        <line x1="12" y1="8" x2="12.01" y2="8"></line>
      </svg>
      <span>You're in <strong>${currentName}</strong> mode. Use the pills at the top to switch ‚Äî <strong>Quick</strong> for faster answers, <strong>Thorough</strong> for deeper analysis.</span>
      <button class="mode-hint-dismiss" onclick="dismissModeHint()">‚úï</button>
    </div>
  `;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;

  // Auto-dismiss after 15 seconds
  setTimeout(() => dismissModeHint(), 15000);
}

function dismissModeHint() {
  const el = document.getElementById('modeHint');
  if (el) {
    el.style.opacity = '0';
    el.style.transform = 'translateY(-8px)';
    setTimeout(() => el.remove(), 300);
  }
}

function addThinking(text) {
  const container = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = 'thinking';
  div.id = 'thinkingIndicator';
  div.innerHTML = `
    <div class="thinking-dots"><span></span><span></span><span></span></div>
    <span class="thinking-text">${text || 'Thinking...'}</span>
  `;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

function updateThinking(text) {
  const el = document.getElementById('thinkingIndicator');
  if (el) {
    const textEl = el.querySelector('.thinking-text');
    if (textEl) textEl.textContent = text;
  }
}

function removeThinking() {
  const el = document.getElementById('thinkingIndicator');
  if (el) el.remove();
}

function addUrlAnalysis(url) {
  const container = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = 'url-analysis';
  div.id = 'urlAnalysis';
  div.innerHTML = `
    <div class="url-analysis-spinner"></div>
    <span class="url-analysis-text">Analyzing ${truncateUrl(url)}...</span>
  `;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

function removeUrlAnalysis() {
  const el = document.getElementById('urlAnalysis');
  if (el) el.remove();
}

function truncateUrl(url) {
  try {
    const u = new URL(url);
    return u.hostname;
  } catch { return url.substring(0, 40); }
}

// ===== SEND =====
async function sendMessage() {
  const input = document.getElementById('userInput');
  const text = input.value.trim();
  if (!text || isStreaming) return;

  addMessage('user', text);
  input.value = '';
  autoResize(input);
  updateSendBtn();

  conversationHistory.push({ role: 'user', content: text });
  userMessageCount++;
  betaTrackTiming();
  betaLog('user_message', { messageNumber: userMessageCount, hasUrl: /https?:\/\//.test(text), length: text.length });
  analyzeUserMessage(text, userMessageCount);

  isStreaming = true;
  document.getElementById('sendBtn').disabled = true;
  document.getElementById('stopBtn').classList.add('active');

  // Create abort controller for this request
  currentAbortController = new AbortController();

  try {
    // Check for URL in the message ‚Äî fetch it first
    const urlMatch = text.match(/https?:\/\/[^\s,)]+/);
    let enhancedMessages = [...conversationHistory];

    if (urlMatch) {
      addUrlAnalysis(urlMatch[0]);
      try {
        const urlData = await fetchUrl(urlMatch[0]);
        removeUrlAnalysis();
        if (urlData) {
          betaSession.urlsFetched.push(urlMatch[0]);
          betaLog('url_fetch_success', { url: urlMatch[0] });
          enhancedMessages.push({
            role: 'user',
            content: `[FigStudio tool result ‚Äî web_fetch for ${urlMatch[0]}]\n\nPage title: ${urlData.title}\nMeta description: ${urlData.description}\nTechnology signals: ${urlData.tech}\n\n${urlData.content}\n\n[End of tool result. CRITICAL: Only use facts from the data above. Do NOT invent any person names, doctor names, owner names, or staff names ‚Äî if no name appears in the data above, say "the business" or "the clinic" instead. If you need a name, ask the user. Now analyze this site and respond naturally.]`
          });
        }
      } catch(e) {
        removeUrlAnalysis();
        betaSession.fetchErrors.push(urlMatch[0]);
        betaLog('url_fetch_error', { url: urlMatch[0], error: e.message });
        // Tell the AI the fetch failed so it can handle gracefully
        enhancedMessages.push({
          role: 'user',
          content: `[FigStudio tool result ‚Äî web_fetch FAILED for ${urlMatch[0]}]\n\nThe platform could not fetch this URL. Possible reasons: the site is down, the URL is wrong, it's behind Cloudflare protection, or it blocks automated access.\n\nDo NOT pretend you have data about this site. Tell the user the site couldn't be loaded, ask them to double-check the URL, and in the meantime work with whatever context they've already given you (client description, business type, etc.). Stay useful ‚Äî don't just say "I can't help." You can still ask smart questions and plan the approach even without site data.`
        });
      }
    }

    addThinking('Analyzing...');

    const response = await callClaude(enhancedMessages);
    removeThinking();
    addMessage('assistant', response);
    conversationHistory.push({ role: 'assistant', content: response });
    betaLog('assistant_response', { length: response.length, hasDeliverable: /```html-deliverable/.test(response) });
    analyzeAssistantResponse(response, conversationHistory.length);
    betaAutoSave(); // Save after every exchange ‚Äî never lose data

    // Show mode discovery hint after 3rd user message (once only)
    if (userMessageCount === 3 && !modeHintShown) {
      modeHintShown = true;
      showModeHint();
    }

    // Beta pulse triggers
    if (userMessageCount === 3) betaCheckPulse('message_3');
    if (userMessageCount === 8) betaCheckPulse('message_8');
    if (urlMatch && betaSession.urlsFetched.length > 0) {
      setTimeout(() => betaCheckPulse('after_analysis'), 5000);
    }
  } catch(err) {
    removeThinking();
    removeUrlAnalysis();
    if (err.name === 'AbortError') {
      // User stopped ‚Äî don't show error, just clean up
    } else {
      showError(text);
      console.error('FigStudio error:', err);
    }
  }

  currentAbortController = null;
  isStreaming = false;
  document.getElementById('sendBtn').disabled = false;
  document.getElementById('stopBtn').classList.remove('active');
  input.focus();
}

function showError(lastMessage) {
  const container = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = 'msg';
  div.innerHTML = `
    <div class="msg-error">
      <svg class="msg-error-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#F87171" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
      <div class="msg-error-content">
        <div class="msg-error-text">Couldn't process that request. This can happen with complex or very long responses.</div>
        <button class="msg-error-retry" onclick="retryLastMessage(this)">Try again</button>
      </div>
    </div>
  `;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
  div.dataset.lastMessage = lastMessage;
}

function retryLastMessage(btn) {
  const errorDiv = btn.closest('.msg');
  const lastMessage = errorDiv.dataset.lastMessage;
  errorDiv.remove();

  // Remove the last user message from history (it'll be re-added by sendMessage)
  if (conversationHistory.length > 0 && conversationHistory[conversationHistory.length - 1].role === 'user') {
    conversationHistory.pop();
  }
  // Remove the user message bubble too
  const msgs = document.querySelectorAll('.msg-user');
  if (msgs.length > 0) {
    msgs[msgs.length - 1].remove();
  }

  // Re-send
  const input = document.getElementById('userInput');
  input.value = lastMessage;
  autoResize(input);
  updateSendBtn();
  sendMessage();
}

// ===== COPY MESSAGE =====
function copyMessage(btn) {
  betaTrackFeature('copy');
  const msg = btn.closest('.msg');
  const raw = msg.dataset.rawContent;
  if (!raw) return;

  // Strip deliverable code blocks from copied text
  const cleanText = raw.replace(/```html-deliverable\n[\s\S]*?```/g, '[Deliverable ‚Äî see Preview panel]');

  navigator.clipboard.writeText(cleanText).then(() => {
    btn.classList.add('copied');
    const label = btn.querySelector('svg').nextSibling;
    const originalText = btn.textContent.trim();
    btn.innerHTML = btn.innerHTML.replace('Copy', 'Copied');
    setTimeout(() => {
      btn.classList.remove('copied');
      btn.innerHTML = btn.innerHTML.replace('Copied', 'Copy');
    }, 1500);
  }).catch(() => {
    // Fallback for older browsers
    const ta = document.createElement('textarea');
    ta.value = cleanText;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    btn.classList.add('copied');
    btn.innerHTML = btn.innerHTML.replace('Copy', 'Copied');
    setTimeout(() => {
      btn.classList.remove('copied');
      btn.innerHTML = btn.innerHTML.replace('Copied', 'Copy');
    }, 1500);
  });
}

// ===== STOP GENERATION =====
let currentAbortController = null;

function stopGeneration() {
  betaTrackFeature('stop');
  if (currentAbortController) {
    currentAbortController.abort();
    currentAbortController = null;
  }
  removeThinking();
  removeUrlAnalysis();
  isStreaming = false;
  document.getElementById('sendBtn').disabled = false;
  document.getElementById('stopBtn').classList.remove('active');
  document.getElementById('userInput').focus();
}

// ===== CLAUDE API (via backend proxy) =====
async function callClaude(messages) {
  // Inject current mode behavior into system prompt
  let currentSystem = systemPrompt.replace(
    /\n## Current mode\n[\s\S]*$/,
    getModeInstructions()
  );

  const resp = await fetch('/api/chat', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 8192,
      system: currentSystem,
      messages: messages
    }),
    signal: currentAbortController?.signal
  });

  if (!resp.ok) {
    const err = await resp.json().catch(() => ({}));
    throw new Error(err.error?.message || `API error ${resp.status}`);
  }

  const data = await resp.json();
  return data.content[0].text;
}

// ===== URL FETCHING =====
async function fetchUrl(url) {
  try {
    const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
    const resp = await fetch(proxyUrl, { signal: AbortSignal.timeout(15000) });
    if (!resp.ok) return null;

    const html = await resp.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');

    const title = doc.querySelector('title')?.textContent?.trim() || 'No title';
    const description = doc.querySelector('meta[name="description"]')?.content || 'No meta description found';

    // Tech detection
    const techSignals = [];
    const htmlLower = html.toLowerCase();

    // Frameworks & CMS
    if (htmlLower.includes('bootstrap')) {
      // Detect Bootstrap version
      if (htmlLower.includes('col-xs-') && !htmlLower.includes('col-xl-')) techSignals.push('Bootstrap 3 (outdated ‚Äî EOL since 2019, no flexbox grid)');
      else if (htmlLower.includes('col-xl-') || htmlLower.includes('bootstrap@5') || htmlLower.includes('bootstrap/5')) techSignals.push('Bootstrap 5 (modern)');
      else if (htmlLower.includes('bootstrap@4') || htmlLower.includes('bootstrap/4')) techSignals.push('Bootstrap 4');
      else techSignals.push('Bootstrap (version unclear)');
    }
    if (htmlLower.includes('tailwind') || htmlLower.includes('tw-')) techSignals.push('Tailwind CSS');
    if (htmlLower.includes('jquery') || htmlLower.includes('jquery.min.js')) techSignals.push('jQuery');
    if (htmlLower.includes('wordpress') || htmlLower.includes('wp-content')) techSignals.push('WordPress');
    if (htmlLower.includes('react')) techSignals.push('React');
    if (htmlLower.includes('next') && htmlLower.includes('__next')) techSignals.push('Next.js');
    if (htmlLower.includes('wix.com')) techSignals.push('Wix');
    if (htmlLower.includes('squarespace')) techSignals.push('Squarespace');
    if (htmlLower.includes('webflow')) techSignals.push('Webflow');
    if (htmlLower.includes('shopify')) techSignals.push('Shopify');
    if (htmlLower.includes('elementor')) techSignals.push('Elementor');

    // SSL & canonical
    if (html.includes('https://') || html.includes('ssl')) techSignals.push('SSL detected');
    if (doc.querySelector('link[rel="canonical"]')) techSignals.push('Has canonical URL');
    if (!doc.querySelector('link[rel="canonical"]')) techSignals.push('Missing canonical URL');

    // Structured data
    const jsonLd = doc.querySelectorAll('script[type="application/ld+json"]');
    if (jsonLd.length > 0) techSignals.push(`Structured data (${jsonLd.length} JSON-LD blocks)`);
    else techSignals.push('No structured data (JSON-LD) found');

    // ===== MOBILE RESPONSIVENESS DEEP ANALYSIS =====
    const mobileSignals = [];

    // 1. Viewport meta tag
    const viewportMeta = doc.querySelector('meta[name="viewport"]');
    if (!viewportMeta) {
      mobileSignals.push('‚õî NO viewport meta tag ‚Äî mobile browsers will render at ~980px width and shrink. This is the #1 mobile failure.');
    } else {
      const vpContent = viewportMeta.content || '';
      if (vpContent.includes('width=device-width')) {
        mobileSignals.push('‚úÖ Has viewport meta tag with width=device-width');
      } else {
        mobileSignals.push('‚ö†Ô∏è Has viewport meta tag but WITHOUT width=device-width ‚Äî may not render correctly on mobile');
      }
      if (vpContent.includes('user-scalable=no') || vpContent.includes('maximum-scale=1')) {
        mobileSignals.push('‚ö†Ô∏è Viewport disables zoom (user-scalable=no or max-scale=1) ‚Äî accessibility issue');
      }
    }

    // 2. CSS media queries detection
    const styleBlocks = doc.querySelectorAll('style');
    const linkSheets = doc.querySelectorAll('link[rel="stylesheet"]');
    let mediaQueryCount = 0;
    let inlineCSS = '';
    styleBlocks.forEach(s => { inlineCSS += s.textContent; });
    const mediaMatches = inlineCSS.match(/@media[^{]*/g);
    mediaQueryCount = mediaMatches ? mediaMatches.length : 0;
    // Also check in inline HTML (style attributes won't have @media, but script-injected styles might)
    const htmlMediaMatches = html.match(/@media[^{]*/g);
    const totalMediaQueries = htmlMediaMatches ? htmlMediaMatches.length : 0;

    if (totalMediaQueries === 0) {
      mobileSignals.push('‚õî ZERO CSS @media queries found ‚Äî responsiveness is either JS-only (fragile) or absent');
    } else if (totalMediaQueries <= 3) {
      mobileSignals.push(`‚ö†Ô∏è Only ${totalMediaQueries} CSS @media queries ‚Äî minimal responsive CSS`);
    } else {
      mobileSignals.push(`‚úÖ ${totalMediaQueries} CSS @media queries found ‚Äî has responsive CSS breakpoints`);
    }

    // 3. JS-dependent responsiveness detection
    const jsResponsive = [];
    if (html.includes('window.innerWidth') || html.includes('innerWidth')) jsResponsive.push('window.innerWidth checks');
    if (html.includes('matchMedia')) jsResponsive.push('matchMedia()');
    if (html.includes('resize')) jsResponsive.push('resize event listeners');
    if (html.includes('orientationchange')) jsResponsive.push('orientationchange');
    if (jsResponsive.length > 0 && totalMediaQueries <= 3) {
      mobileSignals.push(`‚ö†Ô∏è Responsiveness appears JS-dependent (${jsResponsive.join(', ')}). If JavaScript fails, layout breaks on mobile.`);
    } else if (jsResponsive.length > 0) {
      mobileSignals.push(`JS-assisted responsive: ${jsResponsive.join(', ')}`);
    }

    // 4. Fixed-width containers that could break mobile
    const fixedWidthMatches = html.match(/width\s*:\s*(\d{4,})px/g) || [];
    const fixedWidthLarge = fixedWidthMatches.filter(m => {
      const px = parseInt(m.match(/(\d+)/)[1]);
      return px >= 960;
    });
    if (fixedWidthLarge.length > 0) {
      mobileSignals.push(`‚õî ${fixedWidthLarge.length} fixed-width elements ‚â•960px found ‚Äî will overflow on mobile screens`);
    }
    // Check for common fixed-width containers
    const fixedContainers = html.match(/width\s*:\s*(9\d{2}|1[0-9]{3})px/g);
    if (fixedContainers && fixedContainers.length > 0) {
      mobileSignals.push(`Fixed-width containers: ${fixedContainers.slice(0, 5).join(', ')}`);
    }

    // 5. Responsive images
    const hasSrcset = doc.querySelectorAll('img[srcset], source[srcset]').length;
    const hasPicture = doc.querySelectorAll('picture').length;
    const hasLazyLoad = doc.querySelectorAll('img[loading="lazy"], img[data-src], img[data-lazy-src]').length;
    const imgSignals = [];
    if (hasSrcset > 0) imgSignals.push(`${hasSrcset} images with srcset`);
    if (hasPicture > 0) imgSignals.push(`${hasPicture} <picture> elements`);
    if (hasLazyLoad > 0) imgSignals.push(`${hasLazyLoad} lazy-loaded images`);
    if (imgSignals.length > 0) {
      mobileSignals.push(`‚úÖ Responsive images: ${imgSignals.join(', ')}`);
    } else if (images.length > 3) {
      mobileSignals.push(`‚ö†Ô∏è ${images.length} images but NO srcset, <picture>, or lazy loading ‚Äî mobile users download full-size desktop images`);
    }

    // 6. Touch/mobile UX signals
    if (htmlLower.includes('hamburger') || htmlLower.includes('mobile-nav') || htmlLower.includes('nav-toggle') || htmlLower.includes('menu-toggle') || htmlLower.includes('navbar-toggle') || htmlLower.includes('navbar-toggler')) {
      mobileSignals.push('‚úÖ Has mobile navigation toggle (hamburger menu)');
    }
    if (htmlLower.includes('touch-action') || htmlLower.includes('touchstart') || htmlLower.includes('touchmove')) {
      mobileSignals.push('Has touch event handling');
    }

    // 7. Font size check ‚Äî tiny text on mobile
    const tinyFontMatches = inlineCSS.match(/font-size\s*:\s*(\d+)px/g) || [];
    const tinyFonts = tinyFontMatches.filter(m => parseInt(m.match(/(\d+)/)[1]) < 12);
    if (tinyFonts.length > 3) {
      mobileSignals.push(`‚ö†Ô∏è ${tinyFonts.length} font-size declarations under 12px ‚Äî may be unreadable on mobile`);
    }

    // Content extraction
    const bodyText = doc.body?.textContent?.replace(/\s+/g, ' ').trim().substring(0, 4000) || '';

    // Links
    const links = doc.querySelectorAll('a[href]');
    const internalLinks = [...links].filter(a => {
      try { return new URL(a.href, url).hostname === new URL(url).hostname; } catch { return false; }
    });

    // Images
    const images = doc.querySelectorAll('img');
    const imgInfo = [...images].slice(0, 10).map(img => {
      const src = img.src || img.getAttribute('data-src') || img.getAttribute('data-lazy-src') || '';
      const alt = img.alt || 'no alt text';
      return `  - ${src ? src.substring(0, 80) : 'no src'} (alt: "${alt}")`;
    }).join('\n');

    // Headings structure
    const h1s = doc.querySelectorAll('h1');
    const h2s = doc.querySelectorAll('h2');
    const h3s = doc.querySelectorAll('h3');
    const headingsInfo = [];
    [...h1s].forEach(h => headingsInfo.push(`H1: "${h.textContent.trim().substring(0, 80)}"`));
    [...h2s].slice(0, 5).forEach(h => headingsInfo.push(`H2: "${h.textContent.trim().substring(0, 80)}"`));
    [...h3s].slice(0, 5).forEach(h => headingsInfo.push(`H3: "${h.textContent.trim().substring(0, 80)}"`));

    // Forms
    const forms = doc.querySelectorAll('form');

    // Phone numbers
    const phoneMatch = bodyText.match(/[\d\s.()-]{9,15}/g);

    // Social links
    const socialLinks = [...links].filter(a => {
      const href = (a.href || '').toLowerCase();
      return href.includes('facebook') || href.includes('instagram') || href.includes('twitter') || href.includes('linkedin') || href.includes('youtube') || href.includes('tiktok');
    });

    // ===== SITE NAVIGATION & SUBPAGES ANALYSIS =====
    const navSignals = [];

    // Extract all internal link paths to map site structure
    const internalPaths = [...internalLinks].map(a => {
      try {
        const u = new URL(a.href, url);
        return u.pathname.replace(/\/$/, '') || '/';
      } catch { return null; }
    }).filter(Boolean);
    const uniquePaths = [...new Set(internalPaths)].filter(p => p !== '/');

    // Detect blog
    const blogKeywords = ['blog', 'noticias', 'news', 'articulos', 'articles', 'posts', 'actualidad', 'novedades'];
    const blogLinks = [...internalLinks].filter(a => {
      const href = (a.href || '').toLowerCase();
      const text = (a.textContent || '').toLowerCase().trim();
      return blogKeywords.some(k => href.includes(k) || text.includes(k));
    });
    const hasBlogSection = blogLinks.length > 0 || blogKeywords.some(k => htmlLower.includes(k));

    // Detect key pages from navigation
    const navEl = doc.querySelector('nav, [role="navigation"], .navbar, .nav, .menu, #menu, #nav');
    let navLinks = [];
    if (navEl) {
      navLinks = [...navEl.querySelectorAll('a')].map(a => ({
        text: a.textContent.trim().substring(0, 50),
        href: a.href || a.getAttribute('href') || ''
      })).filter(l => l.text && l.text.length > 0);
    }

    // If no nav element found, try to detect nav-like link clusters
    if (navLinks.length === 0) {
      const allNavCandidates = doc.querySelectorAll('header a, .header a, #header a, .navegacion a, .navigation a');
      navLinks = [...allNavCandidates].map(a => ({
        text: a.textContent.trim().substring(0, 50),
        href: a.href || a.getAttribute('href') || ''
      })).filter(l => l.text && l.text.length > 0);
    }

    if (navLinks.length > 0) {
      navSignals.push(`Navigation links found (${navLinks.length}): ${navLinks.slice(0, 10).map(l => l.text).join(' ¬∑ ')}`);
    } else {
      navSignals.push('‚ö†Ô∏è No clear navigation menu detected ‚Äî site may lack standard nav structure');
    }

    if (hasBlogSection) {
      navSignals.push(`‚úÖ Blog/news section detected (${blogLinks.length} blog-related links found)`);
    } else {
      navSignals.push('No blog or news section detected');
    }

    // Detect sitemap
    if (htmlLower.includes('sitemap')) {
      navSignals.push('Sitemap reference found');
    }

    // Map discovered subpages
    if (uniquePaths.length > 0) {
      navSignals.push(`Discovered ${uniquePaths.length} unique internal paths: ${uniquePaths.slice(0, 15).join(', ')}${uniquePaths.length > 15 ? '...' : ''}`);
    } else {
      navSignals.push('‚ö†Ô∏è No internal subpage links found ‚Äî this may be a single-page site or content is loaded dynamically');
    }

    // Detect if single-page (anchors only)
    const anchorLinks = [...internalLinks].filter(a => {
      const href = a.getAttribute('href') || '';
      return href.startsWith('#') || href.includes('/#');
    });
    if (anchorLinks.length > 3 && uniquePaths.length < 3) {
      navSignals.push('Appears to be a single-page site (mostly anchor links, few actual subpages)');
    }

    // ===== PERSON/NAME DETECTION =====
    // Extract names explicitly mentioned on the page (Dr., Dra., etc.)
    const namePatterns = bodyText.match(/(?:Dr\.?|Dra\.?|Doctor|Doctora|Prof\.?|Lic\.?)\s+[A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±]+(?:\s+[A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±]+){0,3}/g) || [];
    const uniqueNames = [...new Set(namePatterns)].slice(0, 5);

    const content = `
‚ö†Ô∏è IMPORTANT: Only reference names that appear in this data. If no person names are listed below, do NOT invent any. Use "the business", "the clinic", "the owner" instead.

PERSON NAMES FOUND ON PAGE:
${uniqueNames.length > 0 ? uniqueNames.map(n => `- ${n}`).join('\n') : '- NONE FOUND. Do not invent or guess any names.'}

SITE STRUCTURE:
- Internal links: ${internalLinks.length}
- Total images: ${images.length}
- Forms found: ${forms.length}
- H1 tags: ${h1s.length}
- H2 tags: ${h2s.length}
- Social media links: ${socialLinks.length} (${socialLinks.map(a => { try { return new URL(a.href).hostname; } catch { return ''; }}).filter(Boolean).join(', ') || 'none'})

NAVIGATION & SITE PAGES:
${navSignals.join('\n')}

HEADING HIERARCHY:
${headingsInfo.join('\n') || 'No headings found'}

IMAGES (first 10):
${imgInfo || 'No images detected'}

MOBILE & RESPONSIVENESS ANALYSIS:
${mobileSignals.join('\n')}

CONTACT SIGNALS:
- Phone visible: ${phoneMatch ? 'Yes' : 'Not easily found'}
- Has form: ${forms.length > 0 ? 'Yes' : 'No'}
- Has map/address: ${htmlLower.includes('map') || htmlLower.includes('maps') || htmlLower.includes('address') || htmlLower.includes('direcc') ? 'Likely' : 'Not detected'}

TRUST & REVIEW SIGNALS:
- Reviews/testimonials section: ${htmlLower.includes('review') || htmlLower.includes('testimonial') || htmlLower.includes('opinion') || htmlLower.includes('rese√±a') ? 'Possibly present' : 'Not detected'}
- Has Google Maps embed: ${htmlLower.includes('maps.google') || htmlLower.includes('google.com/maps') ? 'Yes' : 'No'}

GOOGLE BUSINESS & LOCAL SEO SIGNALS:
- Google Maps embed on page: ${htmlLower.includes('maps.google') || htmlLower.includes('google.com/maps') || htmlLower.includes('maps.googleapis') ? 'Yes' : 'No'}
- Google Business link on page: ${htmlLower.includes('google.com/maps/place') || htmlLower.includes('business.google') || htmlLower.includes('g.page') ? 'Yes ‚Äî links to Google Business profile' : 'No link to Google Business profile found'}
- Review platform links: ${[...(htmlLower.includes('doctoralia') ? ['Doctoralia'] : []), ...(htmlLower.includes('yelp') ? ['Yelp'] : []), ...(htmlLower.includes('tripadvisor') ? ['TripAdvisor'] : []), ...(htmlLower.includes('trustpilot') ? ['Trustpilot'] : []), ...(htmlLower.includes('google.com/maps') ? ['Google Maps'] : [])].join(', ') || 'None detected'}
- Local business schema (LocalBusiness JSON-LD): ${html.includes('LocalBusiness') || html.includes('Dentist') || html.includes('MedicalBusiness') || html.includes('Restaurant') || html.includes('Store') ? 'Yes' : 'No'}
- NOTE: This analysis can only detect what's ON the website. The business may have a Google Business Profile that isn't linked from the site ‚Äî that's a missed opportunity worth investigating.

BODY TEXT (first 3000 chars):
${bodyText.substring(0, 3000)}
    `.trim();

    return { title, description, tech: techSignals.join(', '), content };
  } catch(e) {
    return null;
  }
}

// ===== DELIVERABLE DETECTION & VERSIONING =====
function checkForDeliverable(content) {
  const match = content.match(/```html-deliverable\n([\s\S]*?)```/);
  if (match) {
    const html = match[1];
    // Add to history
    deliverableHistory.push(html);
    currentVersionIndex = deliverableHistory.length - 1;
    betaSession.deliverableCount++;
    betaLog('deliverable_generated', { version: deliverableHistory.length });
    betaCheckPulse('after_deliverable');
    showPreview(html);
    updateVersionUI();
  }
}

function showPreview(html) {
  const iframe = document.getElementById('previewIframe');
  const empty = document.getElementById('previewEmpty');

  empty.style.display = 'none';
  iframe.style.display = 'block';

  // Wrap the deliverable HTML to contain it within the iframe without overflow
  const wrappedHtml = html.replace('</head>', `
    <style>
      html, body { margin: 0; padding: 0; width: 100%; overflow-x: hidden; }
      body { transform-origin: top left; }
    </style>
  </head>`);
  iframe.srcdoc = wrappedHtml;

  // After iframe loads, scale content to fit panel width
  iframe.onload = function() {
    try {
      const doc = iframe.contentDocument;
      const body = doc.body;
      if (body) {
        const contentWidth = body.scrollWidth;
        const frameWidth = iframe.clientWidth;
        if (contentWidth > frameWidth && frameWidth > 0) {
          const scale = frameWidth / contentWidth;
          body.style.transform = `scale(${scale})`;
          body.style.transformOrigin = 'top left';
          body.style.width = (contentWidth) + 'px';
          // Adjust iframe height to account for scaling
          const contentHeight = body.scrollHeight;
          iframe.style.height = (contentHeight * scale) + 'px';
        }
      }
    } catch(e) {
      // Cross-origin or other error ‚Äî ignore, it'll still render
    }
  };

  // Make sure preview panel is visible
  const panel = document.getElementById('previewPanel');
  if (panel.style.display === 'none') {
    panel.style.display = 'flex';
    document.getElementById('previewToggle').textContent = 'Preview';
  }
}

function updateVersionUI() {
  const versionEl = document.getElementById('previewVersion');
  const labelEl = document.getElementById('versionLabel');
  const prevBtn = document.getElementById('prevVersionBtn');
  const nextBtn = document.getElementById('nextVersionBtn');

  if (deliverableHistory.length <= 0) {
    versionEl.style.display = 'none';
    return;
  }

  versionEl.style.display = 'flex';
  labelEl.textContent = `v${currentVersionIndex + 1}/${deliverableHistory.length}`;
  prevBtn.disabled = currentVersionIndex <= 0;
  nextBtn.disabled = currentVersionIndex >= deliverableHistory.length - 1;
}

function showVersion(delta) {
  betaTrackFeature('version-nav');
  const newIndex = currentVersionIndex + delta;
  if (newIndex < 0 || newIndex >= deliverableHistory.length) return;
  currentVersionIndex = newIndex;
  showPreview(deliverableHistory[currentVersionIndex]);
  updateVersionUI();
}

// ===== PREVIEW TOGGLE =====
function togglePreview() {
  const panel = document.getElementById('previewPanel');
  const btn = document.getElementById('previewToggle');
  if (panel.style.display === 'none') {
    panel.style.display = 'flex';
    btn.textContent = 'Preview';
  } else {
    panel.style.display = 'none';
    btn.textContent = 'Show Preview';
  }
}

// ===== PDF EXPORT =====
function exportPDF() {
  const iframe = document.getElementById('previewIframe');
  if (!iframe.srcdoc) {
    alert('No deliverable to export yet. Build one first through the conversation.');
    return;
  }
  iframe.contentWindow.print();
}

// ===== MODE SELECTION =====
function getModeInstructions() {
  const modes = {
    quick: `\n## Current mode\nThe user selected **Quick** mode. They want SPEED and DIRECTNESS.\n- Be concise. Short paragraphs, no fluff.\n- Skip the preamble ‚Äî go straight to the answer or action. Never say "I'll analyze..." or "Let me look at..." ‚Äî just deliver the analysis.\n- Website diagnosis: 2-3 sentence summary + 3-5 bullet points with key issues. That's it. Then show what you can do next + one question.\n- Deliver the document/mockup fast. Don't ask "shall I proceed?" ‚Äî just do it.\n- Only ask questions if something is truly ambiguous. Otherwise, make smart assumptions and move.\n- Think: busy professional who wants results NOW.`,
    guided: `\n## Current mode\nThe user selected **Guided** mode (default). Balance depth with collaboration.\n- Never say "I'll analyze..." or "Let me look at..." ‚Äî the user already sees a loading indicator. Go straight into findings.\n- Website diagnosis: 2-3 sentence summary + key findings as a short bullet list + what you can do next + one context question. Not too short (Quick), not too long (Thorough).\n- Explain your reasoning, but stay focused.\n- Ask for input at key decision points (design direction, priority choices, pricing strategy).\n- Provide enough context so the user learns, but don't over-explain.\n- When generating deliverables, present the plan first, then build.\n- Think: collaborative working session where both parties contribute.`,
    thorough: `\n## Current mode\nThe user selected **Thorough** mode. They want DEPTH and COMPLETENESS.\n- Never say "I'll analyze..." ‚Äî go straight into findings.\n- Website diagnosis: use ## Section headers for collapsible cards. Cover every angle in depth. Include data points, comparisons, "why this matters" for every finding.\n- Go deep on analysis. Cover every angle.\n- Include detailed breakdowns: tech stack, SEO, content, UX, accessibility, competitive positioning.\n- In documents, add data points, comparisons, before/after sections, and "why this matters" for every recommendation.\n- Don't rush. Take the time to be comprehensive.\n- When generating mockups, add more sections, more polish, more detail.\n- Ask clarifying questions to make sure nothing is missed.\n- Think: perfectionist who values quality over speed.`
  };
  return modes[currentMode] || modes.guided;
}

function setMode(mode, el) {
  const oldMode = currentMode;
  currentMode = mode;
  document.querySelectorAll('.mode-pill').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
  if (oldMode !== mode) {
    betaSession.modeChanges.push({ from: oldMode, to: mode, messageCount: userMessageCount, timestamp: new Date().toISOString() });
    betaTrackFeature('mode-change');
  }
}

// ===== HELPERS =====
function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
  updateSendBtn();
}

function updateSendBtn() {
  const input = document.getElementById('userInput');
  document.getElementById('sendBtn').disabled = !input.value.trim() || isStreaming;
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
}

function escapeHtml(str) {
  return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>');
}

function renderMarkdown(text) {
  // Strip deliverable code blocks and replace with notice
  text = text.replace(/```html-deliverable\n[\s\S]*?```/g, '%%DELIVERABLE%%');

  // Check if this is a long response with ## sections ‚Äî make them collapsible
  const hasSections = (text.match(/^## /gm) || []).length >= 2;

  if (hasSections) {
    return renderWithSections(text);
  }

  return renderBasicMarkdown(text);
}

function renderBasicMarkdown(text) {
  let html = escapeHtml(text);

  // Bold
  html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
  // Italic
  html = html.replace(/(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)/g, '<em>$1</em>');
  // Inline code
  html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
  // H2 headers
  html = html.replace(/^## (.*$)/gm, '<h2>$1</h2>');
  // H3 headers
  html = html.replace(/^### (.*$)/gm, '<h3>$1</h3>');
  // Horizontal rules
  html = html.replace(/^---$/gm, '<hr>');
  // Unordered lists
  html = html.replace(/^- (.*$)/gm, '<li>$1</li>');
  html = html.replace(/(<li>.*<\/li>(<br>)?)+/g, function(match) {
    return '<ul>' + match.replace(/<br>/g, '') + '</ul>';
  });
  // Numbered lists
  html = html.replace(/^\d+\. (.*$)/gm, '<li>$1</li>');
  // Blockquotes
  html = html.replace(/^&gt; (.*$)/gm, '<blockquote>$1</blockquote>');
  // Paragraphs
  html = html.replace(/\n\n/g, '</p><p>');
  html = '<p>' + html + '</p>';
  // Clean up
  html = html.replace(/<p><\/p>/g, '');
  html = html.replace(/<p>(<h[23]>)/g, '$1');
  html = html.replace(/(<\/h[23]>)<\/p>/g, '$1');
  html = html.replace(/<p>(<ul>)/g, '$1');
  html = html.replace(/(<\/ul>)<\/p>/g, '$1');
  html = html.replace(/<p>(<hr>)<\/p>/g, '$1');
  html = html.replace(/<p>(<blockquote>)/g, '$1');
  html = html.replace(/(<\/blockquote>)<\/p>/g, '$1');

  html = addDeliverableNotice(html);
  return html;
}

function renderWithSections(text) {
  // Split into intro + sections
  const parts = text.split(/^## /gm);
  const intro = parts[0].trim();
  const sections = parts.slice(1);

  let html = '';

  // Render intro (text before first ## section) as regular markdown
  if (intro) {
    html += renderBasicMarkdown(intro);
  }

  // Render each ## section as a collapsible block
  sections.forEach((section, i) => {
    const lines = section.split('\n');
    const title = lines[0].trim();
    const body = lines.slice(1).join('\n').trim();

    // Get first sentence or line as summary
    const firstLine = body.split('\n').find(l => l.trim() && !l.trim().startsWith('#')) || '';
    const summary = firstLine.replace(/\*\*/g, '').replace(/\*/g, '').substring(0, 120);

    const bodyHtml = renderBasicMarkdown(body);
    const sectionId = 'section-' + Date.now() + '-' + i;

    html += `
      <div class="msg-section" id="${sectionId}">
        <div class="msg-section-header" onclick="toggleSection('${sectionId}')">
          <span class="msg-section-title">${escapeHtml(title).replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</span>
          <span class="msg-section-toggle">‚ñº</span>
        </div>
        ${summary ? `<div class="msg-section-summary">${escapeHtml(summary)}${summary.length >= 120 ? '...' : ''}</div>` : ''}
        <div class="msg-section-body">
          <div class="msg-section-body-inner">${bodyHtml}</div>
        </div>
      </div>
    `;
  });

  html = addDeliverableNotice(html);
  return html;
}

function toggleSection(id) {
  const el = document.getElementById(id);
  if (el) el.classList.toggle('open');
}

function addDeliverableNotice(html) {
  return html.replace(/%%DELIVERABLE%%/g, `
    <div class="deliverable-notice">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
        <polyline points="14 2 14 8 20 8"></polyline>
        <line x1="16" y1="13" x2="8" y2="13"></line>
        <line x1="16" y1="17" x2="8" y2="17"></line>
      </svg>
      Deliverable generated ‚Äî see Preview panel
    </div>
  `);
}

// ===== EVENT LISTENERS =====
document.getElementById('userNameInput').addEventListener('input', () => {
  document.getElementById('setupStart').disabled =
    !document.getElementById('userNameInput').value.trim();
});
document.getElementById('userInput').addEventListener('input', () => updateSendBtn());

// Allow Enter in setup name field to start session
document.getElementById('userNameInput').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    if (!document.getElementById('setupStart').disabled) startSession();
  }
});

// Initial state
document.getElementById('setupStart').disabled = true;
</script>

<!-- Brand footer -->
<div class="brand-footer">
  <svg viewBox="0 0 100 100" fill="none">
    <path d="M50 5C50 5 25 20 20 45C15 70 30 90 50 95C70 90 85 70 80 45C75 20 50 5 50 5Z" fill="currentColor"/>
    <circle cx="50" cy="25" r="5" fill="#C41E3A"/>
  </svg>
  <span>FigSamurai</span>
  <button class="beta-end-btn" onclick="showBetaReport()" title="End beta session and generate report">üìä End session</button>
</div>

</body>
</html>
