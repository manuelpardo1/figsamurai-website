<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FigStudio</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;0,9..40,800;1,9..40,400&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0A0A0B;
    --bg-secondary: #131316;
    --bg-tertiary: #1C1C21;
    --bg-hover: #232329;
    --border: #2A2A32;
    --border-light: #35353F;
    --text: #F0F0F3;
    --text-muted: #9999A8;
    --text-subtle: #6B6B7B;
    --accent: #A67C52;
    --accent-hover: #B88B60;
    --accent-glow: rgba(166, 124, 82, 0.15);
    --accent-soft: rgba(166, 124, 82, 0.08);
    --accent-bronze: #A67C52;
    --accent-warm: #8B7355;
    --samurai-red: #C41E3A;
    --green: #34D399;
    --green-soft: rgba(52, 211, 153, 0.1);
    --amber: #FBBF24;
    --amber-soft: rgba(251, 191, 36, 0.1);
    --red: #F87171;
    --fig-gradient: linear-gradient(135deg, #A67C52, #8B7355);
    --radius: 12px;
    --radius-sm: 8px;
    --radius-xs: 6px;
    --shadow: 0 1px 3px rgba(0,0,0,0.3);
    --shadow-lg: 0 8px 30px rgba(0,0,0,0.4);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  /* ===== TOP BAR ===== */
  .topbar {
    height: 52px;
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    flex-shrink: 0;
    z-index: 10;
  }

  .topbar-left {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .logo-mark {
    width: 28px; height: 28px;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }

  .logo-mark svg {
    width: 24px; height: 24px;
  }

  .logo-text {
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--text);
  }

  .logo-text span {
    color: var(--accent-bronze);
  }

  .topbar-status {
    font-size: 11px;
    color: var(--text-subtle);
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .status-dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--green);
    box-shadow: 0 0 6px rgba(52, 211, 153, 0.5);
  }

  .topbar-right {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .topbar-btn {
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    color: var(--text-muted);
    font-size: 11px;
    font-weight: 500;
    padding: 5px 12px;
    border-radius: var(--radius-xs);
    cursor: pointer;
    transition: all 0.15s;
    font-family: inherit;
  }
  .topbar-btn:hover { background: var(--bg-hover); color: var(--text); border-color: var(--border-light); }

  /* ===== MAIN LAYOUT ===== */
  .main {
    flex: 1;
    display: flex;
    overflow: hidden;
  }

  /* ===== CHAT PANEL ===== */
  .chat-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
    border-right: 1px solid var(--border);
  }

  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 24px 24px 16px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    scroll-behavior: smooth;
  }

  .chat-messages::-webkit-scrollbar { width: 5px; }
  .chat-messages::-webkit-scrollbar-track { background: transparent; }
  .chat-messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  .msg {
    max-width: 720px;
    line-height: 1.65;
    font-size: 14px;
    animation: msgIn 0.3s ease-out;
  }

  @keyframes msgIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .msg-assistant {
    color: var(--text);
  }

  .msg-assistant .msg-label {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--accent);
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .msg-assistant .msg-body {
    color: var(--text);
  }

  .msg-assistant .msg-body p { margin-bottom: 10px; }
  .msg-assistant .msg-body p:last-child { margin-bottom: 0; }
  .msg-assistant .msg-body strong { color: var(--text); font-weight: 600; }
  .msg-assistant .msg-body em { color: var(--text-muted); font-style: italic; }
  .msg-assistant .msg-body code {
    background: var(--bg-tertiary);
    padding: 1px 5px;
    border-radius: 4px;
    font-size: 13px;
  }

  .msg-user {
    align-self: flex-end;
    margin-left: auto;
  }

  .msg-user .msg-body {
    background: var(--accent-soft);
    border: 1px solid rgba(166, 124, 82, 0.2);
    border-radius: var(--radius) var(--radius-xs) var(--radius) var(--radius);
    padding: 12px 16px;
    color: var(--text);
  }

  /* ===== MESSAGE ACTIONS ===== */
  .msg-actions {
    display: flex;
    gap: 4px;
    margin-top: 6px;
    opacity: 0;
    transition: opacity 0.15s;
  }

  .msg:hover .msg-actions,
  .msg-actions.visible {
    opacity: 1;
  }

  .msg-action-btn {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 3px 8px;
    border-radius: 4px;
    background: none;
    border: 1px solid transparent;
    color: var(--text-subtle);
    font-size: 11px;
    font-family: inherit;
    cursor: pointer;
    transition: all 0.15s;
  }

  .msg-action-btn:hover {
    background: var(--bg-tertiary);
    border-color: var(--border);
    color: var(--text-muted);
  }

  .msg-action-btn.copied {
    color: var(--green);
  }

  /* ===== STOP BUTTON ===== */
  .stop-btn {
    display: none;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 6px 14px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    border-radius: var(--radius-xs);
    color: var(--text-muted);
    font-size: 12px;
    font-weight: 500;
    font-family: inherit;
    cursor: pointer;
    margin: 0 auto 8px;
    transition: all 0.15s;
  }

  .stop-btn:hover {
    background: var(--bg-hover);
    color: var(--text);
    border-color: var(--border-light);
  }

  .stop-btn.active {
    display: flex;
  }

  /* ===== THINKING INDICATOR ===== */
  .thinking {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 0;
    animation: msgIn 0.3s ease-out;
  }

  .thinking-dots {
    display: flex;
    gap: 4px;
  }

  .thinking-dots span {
    width: 5px; height: 5px;
    border-radius: 50%;
    background: var(--accent);
    animation: dot 1.2s infinite ease-in-out;
  }
  .thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
  .thinking-dots span:nth-child(3) { animation-delay: 0.4s; }

  @keyframes dot {
    0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); }
    40% { opacity: 1; transform: scale(1); }
  }

  .thinking-text {
    font-size: 12px;
    color: var(--text-subtle);
  }

  /* ===== URL ANALYSIS INDICATOR ===== */
  .url-analysis {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    background: var(--accent-soft);
    border: 1px solid rgba(166, 124, 82, 0.15);
    border-radius: var(--radius-xs);
    margin: 4px 0;
    animation: msgIn 0.3s ease-out;
  }

  .url-analysis-spinner {
    width: 14px; height: 14px;
    border: 2px solid rgba(166, 124, 82, 0.2);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .url-analysis-text {
    font-size: 12px;
    color: var(--accent);
    font-weight: 500;
  }

  /* ===== INPUT AREA ===== */
  .input-area {
    padding: 16px 24px 20px;
    border-top: 1px solid var(--border);
    background: var(--bg-secondary);
  }

  .input-box {
    display: flex;
    align-items: flex-end;
    gap: 10px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 10px 14px;
    transition: border-color 0.2s;
  }

  .input-box:focus-within {
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent-glow);
  }

  .input-box textarea {
    flex: 1;
    background: none;
    border: none;
    color: var(--text);
    font-family: inherit;
    font-size: 14px;
    line-height: 1.5;
    resize: none;
    outline: none;
    max-height: 120px;
    min-height: 21px;
  }

  .input-box textarea::placeholder { color: var(--text-subtle); }

  .send-btn {
    width: 32px; height: 32px;
    border-radius: var(--radius-xs);
    background: var(--fig-gradient);
    border: none;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: opacity 0.15s, transform 0.15s;
  }
  .send-btn:hover { opacity: 0.9; transform: scale(1.05); }
  .send-btn:disabled { opacity: 0.3; cursor: not-allowed; transform: none; }

  .input-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 8px;
    padding: 0 2px;
  }

  .input-hint {
    font-size: 11px;
    color: var(--text-subtle);
  }

  .mode-indicator {
    display: flex;
    gap: 4px;
  }

  .mode-pill {
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 10px;
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text-subtle);
    cursor: pointer;
    transition: all 0.15s;
    font-family: inherit;
  }
  .mode-pill.active {
    background: var(--accent-soft);
    border-color: rgba(166, 124, 82, 0.3);
    color: var(--accent);
  }
  .mode-pill:hover { border-color: var(--border-light); color: var(--text-muted); }

  /* ===== PREVIEW PANEL ===== */
  .preview-panel {
    width: 48%;
    max-width: 600px;
    display: flex;
    flex-direction: column;
    background: var(--bg);
    overflow: hidden;
  }

  .preview-header {
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 16px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .preview-header-left {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .preview-title {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-subtle);
  }

  .preview-version {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .preview-version-btn {
    width: 22px; height: 22px;
    border-radius: 4px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    color: var(--text-subtle);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    transition: all 0.15s;
    font-family: inherit;
    padding: 0;
  }
  .preview-version-btn:hover:not(:disabled) { background: var(--bg-hover); color: var(--text); border-color: var(--border-light); }
  .preview-version-btn:disabled { opacity: 0.25; cursor: not-allowed; }

  .preview-version-label {
    font-size: 10px;
    color: var(--text-subtle);
    font-weight: 500;
    min-width: 40px;
    text-align: center;
  }

  .preview-actions {
    display: flex;
    gap: 6px;
  }

  .preview-body {
    flex: 1;
    overflow-x: hidden;
    overflow-y: auto;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    position: relative;
  }

  .preview-empty {
    text-align: center;
    padding: 40px;
  }

  .preview-empty-icon {
    width: 48px; height: 48px;
    border-radius: 12px;
    background: var(--bg-tertiary);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 14px;
  }

  .preview-empty h3 {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-muted);
    margin-bottom: 6px;
  }

  .preview-empty p {
    font-size: 12px;
    color: var(--text-subtle);
    line-height: 1.5;
    max-width: 260px;
    margin: 0 auto;
  }

  .preview-iframe {
    width: 100%;
    height: 100%;
    border: none;
    background: white;
    display: none;
    overflow-x: hidden;
  }

  /* ===== SETUP MODAL ===== */
  .setup-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(8px);
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .setup-modal {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 36px 40px;
    width: 420px;
    box-shadow: var(--shadow-lg);
  }

  .setup-modal h2 {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 6px;
  }

  .setup-modal .setup-subtitle {
    font-size: 13px;
    color: var(--text-muted);
    margin-bottom: 20px;
    line-height: 1.5;
  }

  .setup-field {
    margin-bottom: 16px;
  }

  .setup-field label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-muted);
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .setup-field input {
    width: 100%;
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 10px 14px;
    color: var(--text);
    font-family: inherit;
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s;
  }

  .setup-field input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent-glow);
  }

  .setup-field input::placeholder { color: var(--text-subtle); }

  .setup-start {
    width: 100%;
    padding: 12px;
    background: var(--fig-gradient);
    border: none;
    border-radius: var(--radius-sm);
    color: white;
    font-family: inherit;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 8px;
    transition: opacity 0.15s;
  }
  .setup-start:hover { opacity: 0.9; }
  .setup-start:disabled { opacity: 0.4; cursor: not-allowed; }

  .setup-note {
    font-size: 11px;
    color: var(--text-subtle);
    text-align: center;
    margin-top: 12px;
    line-height: 1.4;
  }

  /* ===== MARKDOWN RENDERING ===== */
  .msg-body h2 {
    font-size: 14px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--accent);
    margin: 18px 0 8px;
    padding-bottom: 4px;
    border-bottom: 1px solid var(--border);
  }

  .msg-body h3 {
    font-size: 13px;
    font-weight: 600;
    margin: 14px 0 6px;
    color: var(--text);
  }

  .msg-body ul, .msg-body ol {
    padding-left: 20px;
    margin-bottom: 10px;
  }

  .msg-body li {
    margin-bottom: 4px;
  }

  .msg-body blockquote {
    border-left: 3px solid var(--accent);
    padding-left: 12px;
    margin: 10px 0;
    color: var(--text-muted);
    font-style: italic;
  }

  .msg-body hr {
    border: none;
    border-top: 1px solid var(--border);
    margin: 16px 0;
  }

  /* ===== COLLAPSIBLE SECTIONS ===== */
  .msg-section {
    margin: 10px 0;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    overflow: hidden;
  }

  .msg-section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 14px;
    background: var(--bg-tertiary);
    cursor: pointer;
    user-select: none;
    transition: background 0.15s;
  }

  .msg-section-header:hover {
    background: var(--bg-hover);
  }

  .msg-section-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--text);
  }

  .msg-section-toggle {
    font-size: 10px;
    color: var(--text-subtle);
    transition: transform 0.2s;
  }

  .msg-section.open .msg-section-toggle {
    transform: rotate(180deg);
  }

  .msg-section-body {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
  }

  .msg-section.open .msg-section-body {
    max-height: 2000px;
  }

  .msg-section-body-inner {
    padding: 10px 14px 14px;
    font-size: 13px;
    line-height: 1.6;
    color: var(--text-muted);
  }

  .msg-section-body-inner p { margin-bottom: 8px; }
  .msg-section-body-inner p:last-child { margin-bottom: 0; }
  .msg-section-body-inner strong { color: var(--text); }
  .msg-section-body-inner ul { padding-left: 18px; margin-bottom: 8px; }
  .msg-section-body-inner li { margin-bottom: 3px; }

  /* Summary line shown when collapsed */
  .msg-section-summary {
    padding: 0 14px 10px;
    font-size: 12px;
    color: var(--text-subtle);
    line-height: 1.5;
  }

  .msg-section.open .msg-section-summary {
    display: none;
  }

  /* Error message */
  .msg-error {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 12px 16px;
    background: rgba(248, 113, 113, 0.08);
    border: 1px solid rgba(248, 113, 113, 0.2);
    border-radius: var(--radius-sm);
    margin: 4px 0;
    animation: msgIn 0.3s ease-out;
  }

  .msg-error-icon {
    flex-shrink: 0;
    margin-top: 1px;
  }

  .msg-error-content {
    flex: 1;
  }

  .msg-error-text {
    font-size: 13px;
    color: var(--text-muted);
    line-height: 1.5;
    margin-bottom: 8px;
  }

  .msg-error-retry {
    font-size: 12px;
    font-weight: 500;
    color: var(--accent);
    background: none;
    border: 1px solid rgba(166, 124, 82, 0.3);
    border-radius: var(--radius-xs);
    padding: 4px 12px;
    cursor: pointer;
    font-family: inherit;
    transition: all 0.15s;
  }

  .msg-error-retry:hover {
    background: var(--accent-soft);
    border-color: var(--accent);
  }

  /* Deliverable notification */
  .deliverable-notice {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 14px;
    background: var(--green-soft);
    border: 1px solid rgba(52, 211, 153, 0.2);
    border-radius: var(--radius-xs);
    margin-top: 8px;
    font-size: 13px;
    color: var(--green);
    font-weight: 500;
  }

  .deliverable-notice svg {
    flex-shrink: 0;
  }

  /* ===== BRAND FOOTER ===== */
  .brand-footer {
    position: fixed;
    bottom: 8px;
    right: 16px;
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 10px;
    color: var(--text-subtle);
    opacity: 0.5;
    z-index: 5;
    pointer-events: none;
  }

  .brand-footer svg {
    width: 12px;
    height: 12px;
  }

  .brand-footer span {
    letter-spacing: 0.5px;
  }

  /* ===== RESPONSIVE ===== */
  @media (max-width: 900px) {
    .preview-panel { display: none; }
    .chat-panel { border-right: none; }
  }
</style>
</head>
<body>

<!-- SETUP MODAL -->
<div class="setup-overlay" id="setupOverlay">
  <div class="setup-modal">
    <div style="display:flex; align-items:center; gap:10px; margin-bottom:16px;">
      <div class="logo-mark">
        <svg viewBox="0 0 100 100" fill="none">
          <path d="M50 5C50 5 25 20 20 45C15 70 30 90 50 95C70 90 85 70 80 45C75 20 50 5 50 5Z" fill="white"/>
          <path d="M50 15V85" stroke="#A67C52" stroke-width="2" opacity="0.3"/>
          <path d="M50 30C40 40 35 55 38 70" stroke="#A67C52" stroke-width="1.5" opacity="0.2"/>
          <path d="M50 30C60 40 65 55 62 70" stroke="#A67C52" stroke-width="1.5" opacity="0.2"/>
          <circle cx="50" cy="25" r="5" fill="#C41E3A"/>
        </svg>
      </div>
      <span class="logo-text">Fig<span>Studio</span></span>
    </div>
    <h2>Welcome</h2>
    <p class="setup-subtitle">FigStudio helps you build, refine, and sell digital products. Tell me your name and let's get to work.</p>
    <div class="setup-field">
      <label>Your name</label>
      <input type="text" id="userNameInput" placeholder="Your name" autocomplete="off" autofocus>
    </div>
    <button class="setup-start" id="setupStart" onclick="startSession()">Start</button>
    <div class="setup-note">Private beta &middot; FigStudio by FigSamurai</div>
  </div>
</div>

<!-- TOP BAR -->
<div class="topbar">
  <div class="topbar-left">
    <div class="logo-mark">
      <svg viewBox="0 0 100 100" fill="none">
        <path d="M50 5C50 5 25 20 20 45C15 70 30 90 50 95C70 90 85 70 80 45C75 20 50 5 50 5Z" fill="white"/>
        <path d="M50 15V85" stroke="#A67C52" stroke-width="2" opacity="0.3"/>
        <path d="M50 30C40 40 35 55 38 70" stroke="#A67C52" stroke-width="1.5" opacity="0.2"/>
        <path d="M50 30C60 40 65 55 62 70" stroke="#A67C52" stroke-width="1.5" opacity="0.2"/>
        <circle cx="50" cy="25" r="5" fill="#C41E3A"/>
      </svg>
    </div>
    <span class="logo-text">Fig<span>Studio</span></span>
    <div class="topbar-status">
      <span class="status-dot"></span>
      Online
    </div>
  </div>
  <div class="topbar-right">
    <button class="topbar-btn" id="previewToggle" onclick="togglePreview()">Preview</button>
    <button class="topbar-btn" onclick="exportPDF()">Export PDF</button>
  </div>
</div>

<!-- MAIN -->
<div class="main">
  <!-- CHAT -->
  <div class="chat-panel">
    <div class="chat-messages" id="chatMessages"></div>
    <div class="input-area">
      <button class="stop-btn" id="stopBtn" onclick="stopGeneration()">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><rect x="4" y="4" width="16" height="16" rx="2"></rect></svg>
        Stop
      </button>
      <div class="input-box">
        <textarea id="userInput" rows="1" placeholder="Tell me what you need..." oninput="autoResize(this)" onkeydown="handleKey(event)"></textarea>
        <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </div>
      <div class="input-meta">
        <span class="input-hint">Enter to send &middot; Shift+Enter for new line</span>
        <div class="mode-indicator">
          <button class="mode-pill" onclick="setMode('quick', this)" title="Fast and direct — get it done">Quick</button>
          <button class="mode-pill active" onclick="setMode('guided', this)" title="Step by step, with your input">Guided</button>
          <button class="mode-pill" onclick="setMode('thorough', this)" title="Deep analysis, every detail">Thorough</button>
        </div>
      </div>
    </div>
  </div>

  <!-- PREVIEW -->
  <div class="preview-panel" id="previewPanel">
    <div class="preview-header">
      <div class="preview-header-left">
        <span class="preview-title">Preview</span>
        <div class="preview-version" id="previewVersion" style="display:none;">
          <button class="preview-version-btn" id="prevVersionBtn" onclick="showVersion(-1)" disabled title="Previous version">◀</button>
          <span class="preview-version-label" id="versionLabel">v1/1</span>
          <button class="preview-version-btn" id="nextVersionBtn" onclick="showVersion(1)" disabled title="Next version">▶</button>
        </div>
      </div>
      <div class="preview-actions">
        <button class="topbar-btn" onclick="exportPDF()">Download PDF</button>
      </div>
    </div>
    <div class="preview-body">
      <div class="preview-empty" id="previewEmpty">
        <div class="preview-empty-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--text-subtle)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
          </svg>
        </div>
        <h3>No deliverable yet</h3>
        <p>Your documents will appear here as we work together.</p>
      </div>
      <iframe class="preview-iframe" id="previewIframe"></iframe>
    </div>
  </div>
</div>

<script>
// ===== STATE =====
let USER_NAME = '';
let conversationHistory = [];
let systemPrompt = '';
let currentMode = 'guided';
let isStreaming = false;
let deliverableHistory = [];  // Array of HTML strings
let currentVersionIndex = -1; // -1 = no deliverables yet

// ===== SETUP =====
async function startSession() {
  const name = document.getElementById('userNameInput').value.trim();
  if (!name) return;

  USER_NAME = name;

  document.getElementById('setupOverlay').style.display = 'none';

  // Load system prompt
  try {
    const resp = await fetch('system-prompt.md');
    systemPrompt = await resp.text();
  } catch(e) {
    systemPrompt = 'You are FigStudio Advisor, an AI-guided platform for building digital products.';
  }

  // Replace placeholder with real name
  systemPrompt = systemPrompt.replace(/\[USER NAME\]/g, USER_NAME);

  // Add context about available tools and capabilities
  systemPrompt += `\n\n## Tools available in this session\n\nYou have access to a web_fetch tool. When the user shares a website URL, the platform will automatically fetch the page HTML and provide it to you as context. You can then analyze the site for technology stack, content, structure, SEO signals, and more.\n\nThe user's name is: ${USER_NAME}\n\n## Generating visual output\n\nYou can generate TWO types of visual output that render live in the Preview panel:\n\n### 1. Deliverables (documents for the client)\nOne-pagers, full documents, email pitches, slide decks. Output the COMPLETE HTML inside a code block with the language tag \`\`\`html-deliverable. Requirements:\n- Self-contained with all CSS inline or in a <style> block\n- Use A4 dimensions (210mm x 297mm) for print-ready documents\n- Print-ready CSS (@page, print-color-adjust)\n- Import fonts from Google Fonts CDN\n- The deliverable must be COMPLETE and BEAUTIFUL — this is the user's output for their client\n- Include the attribution line at the bottom: "Preparado por ${USER_NAME} · Powered by FigStudio"\n\n### 2. Website mockups (visual design previews)\nWhen the user wants to see what the new or improved website could look like, generate a FULL HTML page that serves as a visual mockup. Use the same \`\`\`html-deliverable code block — the Preview panel will render it identically.\n\nFor website mockups:\n- Build a complete, realistic-looking page — not a wireframe. It should look like a real website.\n- Use modern design patterns, clean typography, good spacing\n- Include placeholder content that matches the client's actual business (real service names, realistic copy, appropriate imagery via placeholder services or CSS gradients/shapes)\n- Make it responsive-looking within the preview\n- Use the client's actual brand colors if known, or propose a professional palette\n- Include all key sections: hero, services, reviews/trust signals, contact, footer\n- The user can ask for different styles, variations, or specific changes — each new version replaces the previous one in Preview\n- This is NOT the final website — it's a visual concept to help the user and their client align on direction before building\n\nThe mockup capability is powerful: the user can say "show me what the new homepage could look like" and you produce a complete visual design in seconds. They can then iterate: "make it more modern", "try a different color scheme", "add a reviews section." Each iteration renders live.`;

  // Reinforce conversation rules at the end (recency bias — model weighs end of prompt heavily)
  systemPrompt += `\n\n## REMEMBER — conversation rules (non-negotiable)\n\n- Your early responses must be 1-2 sentences. No bullet lists, no roadmaps, no previewing what you'll do.\n- If the user already told you what they need, don't repeat it back. Just ask for the ONE thing you're missing (usually: the URL).\n- BAD: "I'd be happy to help! I'll analyze design, SEO, content, performance..." → This is filler. Stop.\n- GOOD: "Sure — drop me the URL and I'll take a look right now." → This is FigStudio.\n- The depth comes AFTER you have data, not before.\n- NEVER INVENT NAMES. Do not generate doctor names, owner names, staff names, or any person's name unless it appears verbatim in the tool data or the user told you. Use "the clinic", "the business", "the owner" instead. This is a trust-destroying error — the user will show this to their client.`;

  // Add mode behavior instructions
  systemPrompt += getModeInstructions();

  // Opening message — Refine-first, concrete, value-forward
  addMessage('assistant', getOpeningMessage());
  document.getElementById('userInput').focus();
}

function getOpeningMessage() {
  return `Hey ${USER_NAME} — what do you need?`;
}

// ===== MESSAGES =====
function addMessage(role, content) {
  const container = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = `msg msg-${role}`;

  if (role === 'assistant') {
    div.innerHTML = `
      <div class="msg-label">
        <svg width="14" height="14" viewBox="0 0 100 100" fill="none">
          <path d="M50 5C50 5 25 20 20 45C15 70 30 90 50 95C70 90 85 70 80 45C75 20 50 5 50 5Z" fill="currentColor" opacity="0.7"/>
          <circle cx="50" cy="25" r="5" fill="#C41E3A"/>
        </svg>
        FigStudio
      </div>
      <div class="msg-body">${renderMarkdown(content)}</div>
      <div class="msg-actions">
        <button class="msg-action-btn" onclick="copyMessage(this)">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
          Copy
        </button>
      </div>
    `;
    // Store raw text for copy
    div.dataset.rawContent = content;
  } else {
    div.innerHTML = `<div class="msg-body">${escapeHtml(content)}</div>`;
  }

  container.appendChild(div);
  container.scrollTop = container.scrollHeight;

  // Check for deliverable HTML in the response
  if (role === 'assistant') {
    checkForDeliverable(content);
  }

  return div;
}

function addThinking(text) {
  const container = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = 'thinking';
  div.id = 'thinkingIndicator';
  div.innerHTML = `
    <div class="thinking-dots"><span></span><span></span><span></span></div>
    <span class="thinking-text">${text || 'Thinking...'}</span>
  `;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

function updateThinking(text) {
  const el = document.getElementById('thinkingIndicator');
  if (el) {
    const textEl = el.querySelector('.thinking-text');
    if (textEl) textEl.textContent = text;
  }
}

function removeThinking() {
  const el = document.getElementById('thinkingIndicator');
  if (el) el.remove();
}

function addUrlAnalysis(url) {
  const container = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = 'url-analysis';
  div.id = 'urlAnalysis';
  div.innerHTML = `
    <div class="url-analysis-spinner"></div>
    <span class="url-analysis-text">Analyzing ${truncateUrl(url)}...</span>
  `;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

function removeUrlAnalysis() {
  const el = document.getElementById('urlAnalysis');
  if (el) el.remove();
}

function truncateUrl(url) {
  try {
    const u = new URL(url);
    return u.hostname;
  } catch { return url.substring(0, 40); }
}

// ===== SEND =====
async function sendMessage() {
  const input = document.getElementById('userInput');
  const text = input.value.trim();
  if (!text || isStreaming) return;

  addMessage('user', text);
  input.value = '';
  autoResize(input);
  updateSendBtn();

  conversationHistory.push({ role: 'user', content: text });

  isStreaming = true;
  document.getElementById('sendBtn').disabled = true;
  document.getElementById('stopBtn').classList.add('active');

  // Create abort controller for this request
  currentAbortController = new AbortController();

  try {
    // Check for URL in the message — fetch it first
    const urlMatch = text.match(/https?:\/\/[^\s,)]+/);
    let enhancedMessages = [...conversationHistory];

    if (urlMatch) {
      addUrlAnalysis(urlMatch[0]);
      try {
        const urlData = await fetchUrl(urlMatch[0]);
        removeUrlAnalysis();
        if (urlData) {
          enhancedMessages.push({
            role: 'user',
            content: `[FigStudio tool result — web_fetch for ${urlMatch[0]}]\n\nPage title: ${urlData.title}\nMeta description: ${urlData.description}\nTechnology signals: ${urlData.tech}\n\n${urlData.content}\n\n[End of tool result. CRITICAL: Only use facts from the data above. Do NOT invent any person names, doctor names, owner names, or staff names — if no name appears in the data above, say "the business" or "the clinic" instead. If you need a name, ask the user. Now analyze this site and respond naturally.]`
          });
        }
      } catch(e) {
        removeUrlAnalysis();
        // Continue without URL data
      }
    }

    addThinking('Analyzing...');

    const response = await callClaude(enhancedMessages);
    removeThinking();
    addMessage('assistant', response);
    conversationHistory.push({ role: 'assistant', content: response });
  } catch(err) {
    removeThinking();
    removeUrlAnalysis();
    if (err.name === 'AbortError') {
      // User stopped — don't show error, just clean up
    } else {
      showError(text);
      console.error('FigStudio error:', err);
    }
  }

  currentAbortController = null;
  isStreaming = false;
  document.getElementById('sendBtn').disabled = false;
  document.getElementById('stopBtn').classList.remove('active');
  input.focus();
}

function showError(lastMessage) {
  const container = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = 'msg';
  div.innerHTML = `
    <div class="msg-error">
      <svg class="msg-error-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#F87171" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
      <div class="msg-error-content">
        <div class="msg-error-text">Couldn't process that request. This can happen with complex or very long responses.</div>
        <button class="msg-error-retry" onclick="retryLastMessage(this)">Try again</button>
      </div>
    </div>
  `;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
  div.dataset.lastMessage = lastMessage;
}

function retryLastMessage(btn) {
  const errorDiv = btn.closest('.msg');
  const lastMessage = errorDiv.dataset.lastMessage;
  errorDiv.remove();

  // Remove the last user message from history (it'll be re-added by sendMessage)
  if (conversationHistory.length > 0 && conversationHistory[conversationHistory.length - 1].role === 'user') {
    conversationHistory.pop();
  }
  // Remove the user message bubble too
  const msgs = document.querySelectorAll('.msg-user');
  if (msgs.length > 0) {
    msgs[msgs.length - 1].remove();
  }

  // Re-send
  const input = document.getElementById('userInput');
  input.value = lastMessage;
  autoResize(input);
  updateSendBtn();
  sendMessage();
}

// ===== COPY MESSAGE =====
function copyMessage(btn) {
  const msg = btn.closest('.msg');
  const raw = msg.dataset.rawContent;
  if (!raw) return;

  // Strip deliverable code blocks from copied text
  const cleanText = raw.replace(/```html-deliverable\n[\s\S]*?```/g, '[Deliverable — see Preview panel]');

  navigator.clipboard.writeText(cleanText).then(() => {
    btn.classList.add('copied');
    const label = btn.querySelector('svg').nextSibling;
    const originalText = btn.textContent.trim();
    btn.innerHTML = btn.innerHTML.replace('Copy', 'Copied');
    setTimeout(() => {
      btn.classList.remove('copied');
      btn.innerHTML = btn.innerHTML.replace('Copied', 'Copy');
    }, 1500);
  }).catch(() => {
    // Fallback for older browsers
    const ta = document.createElement('textarea');
    ta.value = cleanText;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    btn.classList.add('copied');
    btn.innerHTML = btn.innerHTML.replace('Copy', 'Copied');
    setTimeout(() => {
      btn.classList.remove('copied');
      btn.innerHTML = btn.innerHTML.replace('Copied', 'Copy');
    }, 1500);
  });
}

// ===== STOP GENERATION =====
let currentAbortController = null;

function stopGeneration() {
  if (currentAbortController) {
    currentAbortController.abort();
    currentAbortController = null;
  }
  removeThinking();
  removeUrlAnalysis();
  isStreaming = false;
  document.getElementById('sendBtn').disabled = false;
  document.getElementById('stopBtn').classList.remove('active');
  document.getElementById('userInput').focus();
}

// ===== CLAUDE API (via backend proxy) =====
async function callClaude(messages) {
  // Inject current mode behavior into system prompt
  let currentSystem = systemPrompt.replace(
    /\n## Current mode\n[\s\S]*$/,
    getModeInstructions()
  );

  const resp = await fetch('/api/chat', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 8192,
      system: currentSystem,
      messages: messages
    }),
    signal: currentAbortController?.signal
  });

  if (!resp.ok) {
    const err = await resp.json().catch(() => ({}));
    throw new Error(err.error?.message || `API error ${resp.status}`);
  }

  const data = await resp.json();
  return data.content[0].text;
}

// ===== URL FETCHING =====
async function fetchUrl(url) {
  try {
    const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
    const resp = await fetch(proxyUrl, { signal: AbortSignal.timeout(15000) });
    if (!resp.ok) return null;

    const html = await resp.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');

    const title = doc.querySelector('title')?.textContent?.trim() || 'No title';
    const description = doc.querySelector('meta[name="description"]')?.content || 'No meta description found';

    // Tech detection
    const techSignals = [];
    const htmlLower = html.toLowerCase();

    // Frameworks & CMS
    if (htmlLower.includes('bootstrap')) {
      // Detect Bootstrap version
      if (htmlLower.includes('col-xs-') && !htmlLower.includes('col-xl-')) techSignals.push('Bootstrap 3 (outdated — EOL since 2019, no flexbox grid)');
      else if (htmlLower.includes('col-xl-') || htmlLower.includes('bootstrap@5') || htmlLower.includes('bootstrap/5')) techSignals.push('Bootstrap 5 (modern)');
      else if (htmlLower.includes('bootstrap@4') || htmlLower.includes('bootstrap/4')) techSignals.push('Bootstrap 4');
      else techSignals.push('Bootstrap (version unclear)');
    }
    if (htmlLower.includes('tailwind') || htmlLower.includes('tw-')) techSignals.push('Tailwind CSS');
    if (htmlLower.includes('jquery') || htmlLower.includes('jquery.min.js')) techSignals.push('jQuery');
    if (htmlLower.includes('wordpress') || htmlLower.includes('wp-content')) techSignals.push('WordPress');
    if (htmlLower.includes('react')) techSignals.push('React');
    if (htmlLower.includes('next') && htmlLower.includes('__next')) techSignals.push('Next.js');
    if (htmlLower.includes('wix.com')) techSignals.push('Wix');
    if (htmlLower.includes('squarespace')) techSignals.push('Squarespace');
    if (htmlLower.includes('webflow')) techSignals.push('Webflow');
    if (htmlLower.includes('shopify')) techSignals.push('Shopify');
    if (htmlLower.includes('elementor')) techSignals.push('Elementor');

    // SSL & canonical
    if (html.includes('https://') || html.includes('ssl')) techSignals.push('SSL detected');
    if (doc.querySelector('link[rel="canonical"]')) techSignals.push('Has canonical URL');
    if (!doc.querySelector('link[rel="canonical"]')) techSignals.push('Missing canonical URL');

    // Structured data
    const jsonLd = doc.querySelectorAll('script[type="application/ld+json"]');
    if (jsonLd.length > 0) techSignals.push(`Structured data (${jsonLd.length} JSON-LD blocks)`);
    else techSignals.push('No structured data (JSON-LD) found');

    // ===== MOBILE RESPONSIVENESS DEEP ANALYSIS =====
    const mobileSignals = [];

    // 1. Viewport meta tag
    const viewportMeta = doc.querySelector('meta[name="viewport"]');
    if (!viewportMeta) {
      mobileSignals.push('⛔ NO viewport meta tag — mobile browsers will render at ~980px width and shrink. This is the #1 mobile failure.');
    } else {
      const vpContent = viewportMeta.content || '';
      if (vpContent.includes('width=device-width')) {
        mobileSignals.push('✅ Has viewport meta tag with width=device-width');
      } else {
        mobileSignals.push('⚠️ Has viewport meta tag but WITHOUT width=device-width — may not render correctly on mobile');
      }
      if (vpContent.includes('user-scalable=no') || vpContent.includes('maximum-scale=1')) {
        mobileSignals.push('⚠️ Viewport disables zoom (user-scalable=no or max-scale=1) — accessibility issue');
      }
    }

    // 2. CSS media queries detection
    const styleBlocks = doc.querySelectorAll('style');
    const linkSheets = doc.querySelectorAll('link[rel="stylesheet"]');
    let mediaQueryCount = 0;
    let inlineCSS = '';
    styleBlocks.forEach(s => { inlineCSS += s.textContent; });
    const mediaMatches = inlineCSS.match(/@media[^{]*/g);
    mediaQueryCount = mediaMatches ? mediaMatches.length : 0;
    // Also check in inline HTML (style attributes won't have @media, but script-injected styles might)
    const htmlMediaMatches = html.match(/@media[^{]*/g);
    const totalMediaQueries = htmlMediaMatches ? htmlMediaMatches.length : 0;

    if (totalMediaQueries === 0) {
      mobileSignals.push('⛔ ZERO CSS @media queries found — responsiveness is either JS-only (fragile) or absent');
    } else if (totalMediaQueries <= 3) {
      mobileSignals.push(`⚠️ Only ${totalMediaQueries} CSS @media queries — minimal responsive CSS`);
    } else {
      mobileSignals.push(`✅ ${totalMediaQueries} CSS @media queries found — has responsive CSS breakpoints`);
    }

    // 3. JS-dependent responsiveness detection
    const jsResponsive = [];
    if (html.includes('window.innerWidth') || html.includes('innerWidth')) jsResponsive.push('window.innerWidth checks');
    if (html.includes('matchMedia')) jsResponsive.push('matchMedia()');
    if (html.includes('resize')) jsResponsive.push('resize event listeners');
    if (html.includes('orientationchange')) jsResponsive.push('orientationchange');
    if (jsResponsive.length > 0 && totalMediaQueries <= 3) {
      mobileSignals.push(`⚠️ Responsiveness appears JS-dependent (${jsResponsive.join(', ')}). If JavaScript fails, layout breaks on mobile.`);
    } else if (jsResponsive.length > 0) {
      mobileSignals.push(`JS-assisted responsive: ${jsResponsive.join(', ')}`);
    }

    // 4. Fixed-width containers that could break mobile
    const fixedWidthMatches = html.match(/width\s*:\s*(\d{4,})px/g) || [];
    const fixedWidthLarge = fixedWidthMatches.filter(m => {
      const px = parseInt(m.match(/(\d+)/)[1]);
      return px >= 960;
    });
    if (fixedWidthLarge.length > 0) {
      mobileSignals.push(`⛔ ${fixedWidthLarge.length} fixed-width elements ≥960px found — will overflow on mobile screens`);
    }
    // Check for common fixed-width containers
    const fixedContainers = html.match(/width\s*:\s*(9\d{2}|1[0-9]{3})px/g);
    if (fixedContainers && fixedContainers.length > 0) {
      mobileSignals.push(`Fixed-width containers: ${fixedContainers.slice(0, 5).join(', ')}`);
    }

    // 5. Responsive images
    const hasSrcset = doc.querySelectorAll('img[srcset], source[srcset]').length;
    const hasPicture = doc.querySelectorAll('picture').length;
    const hasLazyLoad = doc.querySelectorAll('img[loading="lazy"], img[data-src], img[data-lazy-src]').length;
    const imgSignals = [];
    if (hasSrcset > 0) imgSignals.push(`${hasSrcset} images with srcset`);
    if (hasPicture > 0) imgSignals.push(`${hasPicture} <picture> elements`);
    if (hasLazyLoad > 0) imgSignals.push(`${hasLazyLoad} lazy-loaded images`);
    if (imgSignals.length > 0) {
      mobileSignals.push(`✅ Responsive images: ${imgSignals.join(', ')}`);
    } else if (images.length > 3) {
      mobileSignals.push(`⚠️ ${images.length} images but NO srcset, <picture>, or lazy loading — mobile users download full-size desktop images`);
    }

    // 6. Touch/mobile UX signals
    if (htmlLower.includes('hamburger') || htmlLower.includes('mobile-nav') || htmlLower.includes('nav-toggle') || htmlLower.includes('menu-toggle') || htmlLower.includes('navbar-toggle') || htmlLower.includes('navbar-toggler')) {
      mobileSignals.push('✅ Has mobile navigation toggle (hamburger menu)');
    }
    if (htmlLower.includes('touch-action') || htmlLower.includes('touchstart') || htmlLower.includes('touchmove')) {
      mobileSignals.push('Has touch event handling');
    }

    // 7. Font size check — tiny text on mobile
    const tinyFontMatches = inlineCSS.match(/font-size\s*:\s*(\d+)px/g) || [];
    const tinyFonts = tinyFontMatches.filter(m => parseInt(m.match(/(\d+)/)[1]) < 12);
    if (tinyFonts.length > 3) {
      mobileSignals.push(`⚠️ ${tinyFonts.length} font-size declarations under 12px — may be unreadable on mobile`);
    }

    // Content extraction
    const bodyText = doc.body?.textContent?.replace(/\s+/g, ' ').trim().substring(0, 4000) || '';

    // Links
    const links = doc.querySelectorAll('a[href]');
    const internalLinks = [...links].filter(a => {
      try { return new URL(a.href, url).hostname === new URL(url).hostname; } catch { return false; }
    });

    // Images
    const images = doc.querySelectorAll('img');
    const imgInfo = [...images].slice(0, 10).map(img => {
      const src = img.src || img.getAttribute('data-src') || img.getAttribute('data-lazy-src') || '';
      const alt = img.alt || 'no alt text';
      return `  - ${src ? src.substring(0, 80) : 'no src'} (alt: "${alt}")`;
    }).join('\n');

    // Headings structure
    const h1s = doc.querySelectorAll('h1');
    const h2s = doc.querySelectorAll('h2');
    const h3s = doc.querySelectorAll('h3');
    const headingsInfo = [];
    [...h1s].forEach(h => headingsInfo.push(`H1: "${h.textContent.trim().substring(0, 80)}"`));
    [...h2s].slice(0, 5).forEach(h => headingsInfo.push(`H2: "${h.textContent.trim().substring(0, 80)}"`));
    [...h3s].slice(0, 5).forEach(h => headingsInfo.push(`H3: "${h.textContent.trim().substring(0, 80)}"`));

    // Forms
    const forms = doc.querySelectorAll('form');

    // Phone numbers
    const phoneMatch = bodyText.match(/[\d\s.()-]{9,15}/g);

    // Social links
    const socialLinks = [...links].filter(a => {
      const href = (a.href || '').toLowerCase();
      return href.includes('facebook') || href.includes('instagram') || href.includes('twitter') || href.includes('linkedin') || href.includes('youtube') || href.includes('tiktok');
    });

    // ===== SITE NAVIGATION & SUBPAGES ANALYSIS =====
    const navSignals = [];

    // Extract all internal link paths to map site structure
    const internalPaths = [...internalLinks].map(a => {
      try {
        const u = new URL(a.href, url);
        return u.pathname.replace(/\/$/, '') || '/';
      } catch { return null; }
    }).filter(Boolean);
    const uniquePaths = [...new Set(internalPaths)].filter(p => p !== '/');

    // Detect blog
    const blogKeywords = ['blog', 'noticias', 'news', 'articulos', 'articles', 'posts', 'actualidad', 'novedades'];
    const blogLinks = [...internalLinks].filter(a => {
      const href = (a.href || '').toLowerCase();
      const text = (a.textContent || '').toLowerCase().trim();
      return blogKeywords.some(k => href.includes(k) || text.includes(k));
    });
    const hasBlogSection = blogLinks.length > 0 || blogKeywords.some(k => htmlLower.includes(k));

    // Detect key pages from navigation
    const navEl = doc.querySelector('nav, [role="navigation"], .navbar, .nav, .menu, #menu, #nav');
    let navLinks = [];
    if (navEl) {
      navLinks = [...navEl.querySelectorAll('a')].map(a => ({
        text: a.textContent.trim().substring(0, 50),
        href: a.href || a.getAttribute('href') || ''
      })).filter(l => l.text && l.text.length > 0);
    }

    // If no nav element found, try to detect nav-like link clusters
    if (navLinks.length === 0) {
      const allNavCandidates = doc.querySelectorAll('header a, .header a, #header a, .navegacion a, .navigation a');
      navLinks = [...allNavCandidates].map(a => ({
        text: a.textContent.trim().substring(0, 50),
        href: a.href || a.getAttribute('href') || ''
      })).filter(l => l.text && l.text.length > 0);
    }

    if (navLinks.length > 0) {
      navSignals.push(`Navigation links found (${navLinks.length}): ${navLinks.slice(0, 10).map(l => l.text).join(' · ')}`);
    } else {
      navSignals.push('⚠️ No clear navigation menu detected — site may lack standard nav structure');
    }

    if (hasBlogSection) {
      navSignals.push(`✅ Blog/news section detected (${blogLinks.length} blog-related links found)`);
    } else {
      navSignals.push('No blog or news section detected');
    }

    // Detect sitemap
    if (htmlLower.includes('sitemap')) {
      navSignals.push('Sitemap reference found');
    }

    // Map discovered subpages
    if (uniquePaths.length > 0) {
      navSignals.push(`Discovered ${uniquePaths.length} unique internal paths: ${uniquePaths.slice(0, 15).join(', ')}${uniquePaths.length > 15 ? '...' : ''}`);
    } else {
      navSignals.push('⚠️ No internal subpage links found — this may be a single-page site or content is loaded dynamically');
    }

    // Detect if single-page (anchors only)
    const anchorLinks = [...internalLinks].filter(a => {
      const href = a.getAttribute('href') || '';
      return href.startsWith('#') || href.includes('/#');
    });
    if (anchorLinks.length > 3 && uniquePaths.length < 3) {
      navSignals.push('Appears to be a single-page site (mostly anchor links, few actual subpages)');
    }

    // ===== PERSON/NAME DETECTION =====
    // Extract names explicitly mentioned on the page (Dr., Dra., etc.)
    const namePatterns = bodyText.match(/(?:Dr\.?|Dra\.?|Doctor|Doctora|Prof\.?|Lic\.?)\s+[A-ZÁÉÍÓÚÑ][a-záéíóúñ]+(?:\s+[A-ZÁÉÍÓÚÑ][a-záéíóúñ]+){0,3}/g) || [];
    const uniqueNames = [...new Set(namePatterns)].slice(0, 5);

    const content = `
⚠️ IMPORTANT: Only reference names that appear in this data. If no person names are listed below, do NOT invent any. Use "the business", "the clinic", "the owner" instead.

PERSON NAMES FOUND ON PAGE:
${uniqueNames.length > 0 ? uniqueNames.map(n => `- ${n}`).join('\n') : '- NONE FOUND. Do not invent or guess any names.'}

SITE STRUCTURE:
- Internal links: ${internalLinks.length}
- Total images: ${images.length}
- Forms found: ${forms.length}
- H1 tags: ${h1s.length}
- H2 tags: ${h2s.length}
- Social media links: ${socialLinks.length} (${socialLinks.map(a => { try { return new URL(a.href).hostname; } catch { return ''; }}).filter(Boolean).join(', ') || 'none'})

NAVIGATION & SITE PAGES:
${navSignals.join('\n')}

HEADING HIERARCHY:
${headingsInfo.join('\n') || 'No headings found'}

IMAGES (first 10):
${imgInfo || 'No images detected'}

MOBILE & RESPONSIVENESS ANALYSIS:
${mobileSignals.join('\n')}

CONTACT SIGNALS:
- Phone visible: ${phoneMatch ? 'Yes' : 'Not easily found'}
- Has form: ${forms.length > 0 ? 'Yes' : 'No'}
- Has map/address: ${htmlLower.includes('map') || htmlLower.includes('maps') || htmlLower.includes('address') || htmlLower.includes('direcc') ? 'Likely' : 'Not detected'}

TRUST & REVIEW SIGNALS:
- Reviews/testimonials section: ${htmlLower.includes('review') || htmlLower.includes('testimonial') || htmlLower.includes('opinion') || htmlLower.includes('reseña') ? 'Possibly present' : 'Not detected'}
- Has Google Maps embed: ${htmlLower.includes('maps.google') || htmlLower.includes('google.com/maps') ? 'Yes' : 'No'}

GOOGLE BUSINESS & LOCAL SEO SIGNALS:
- Google Maps embed on page: ${htmlLower.includes('maps.google') || htmlLower.includes('google.com/maps') || htmlLower.includes('maps.googleapis') ? 'Yes' : 'No'}
- Google Business link on page: ${htmlLower.includes('google.com/maps/place') || htmlLower.includes('business.google') || htmlLower.includes('g.page') ? 'Yes — links to Google Business profile' : 'No link to Google Business profile found'}
- Review platform links: ${[...(htmlLower.includes('doctoralia') ? ['Doctoralia'] : []), ...(htmlLower.includes('yelp') ? ['Yelp'] : []), ...(htmlLower.includes('tripadvisor') ? ['TripAdvisor'] : []), ...(htmlLower.includes('trustpilot') ? ['Trustpilot'] : []), ...(htmlLower.includes('google.com/maps') ? ['Google Maps'] : [])].join(', ') || 'None detected'}
- Local business schema (LocalBusiness JSON-LD): ${html.includes('LocalBusiness') || html.includes('Dentist') || html.includes('MedicalBusiness') || html.includes('Restaurant') || html.includes('Store') ? 'Yes' : 'No'}
- NOTE: This analysis can only detect what's ON the website. The business may have a Google Business Profile that isn't linked from the site — that's a missed opportunity worth investigating.

BODY TEXT (first 3000 chars):
${bodyText.substring(0, 3000)}
    `.trim();

    return { title, description, tech: techSignals.join(', '), content };
  } catch(e) {
    return null;
  }
}

// ===== DELIVERABLE DETECTION & VERSIONING =====
function checkForDeliverable(content) {
  const match = content.match(/```html-deliverable\n([\s\S]*?)```/);
  if (match) {
    const html = match[1];
    // Add to history
    deliverableHistory.push(html);
    currentVersionIndex = deliverableHistory.length - 1;
    showPreview(html);
    updateVersionUI();
  }
}

function showPreview(html) {
  const iframe = document.getElementById('previewIframe');
  const empty = document.getElementById('previewEmpty');

  empty.style.display = 'none';
  iframe.style.display = 'block';

  // Wrap the deliverable HTML to contain it within the iframe without overflow
  const wrappedHtml = html.replace('</head>', `
    <style>
      html, body { margin: 0; padding: 0; width: 100%; overflow-x: hidden; }
      body { transform-origin: top left; }
    </style>
  </head>`);
  iframe.srcdoc = wrappedHtml;

  // After iframe loads, scale content to fit panel width
  iframe.onload = function() {
    try {
      const doc = iframe.contentDocument;
      const body = doc.body;
      if (body) {
        const contentWidth = body.scrollWidth;
        const frameWidth = iframe.clientWidth;
        if (contentWidth > frameWidth && frameWidth > 0) {
          const scale = frameWidth / contentWidth;
          body.style.transform = `scale(${scale})`;
          body.style.transformOrigin = 'top left';
          body.style.width = (contentWidth) + 'px';
          // Adjust iframe height to account for scaling
          const contentHeight = body.scrollHeight;
          iframe.style.height = (contentHeight * scale) + 'px';
        }
      }
    } catch(e) {
      // Cross-origin or other error — ignore, it'll still render
    }
  };

  // Make sure preview panel is visible
  const panel = document.getElementById('previewPanel');
  if (panel.style.display === 'none') {
    panel.style.display = 'flex';
    document.getElementById('previewToggle').textContent = 'Preview';
  }
}

function updateVersionUI() {
  const versionEl = document.getElementById('previewVersion');
  const labelEl = document.getElementById('versionLabel');
  const prevBtn = document.getElementById('prevVersionBtn');
  const nextBtn = document.getElementById('nextVersionBtn');

  if (deliverableHistory.length <= 0) {
    versionEl.style.display = 'none';
    return;
  }

  versionEl.style.display = 'flex';
  labelEl.textContent = `v${currentVersionIndex + 1}/${deliverableHistory.length}`;
  prevBtn.disabled = currentVersionIndex <= 0;
  nextBtn.disabled = currentVersionIndex >= deliverableHistory.length - 1;
}

function showVersion(delta) {
  const newIndex = currentVersionIndex + delta;
  if (newIndex < 0 || newIndex >= deliverableHistory.length) return;
  currentVersionIndex = newIndex;
  showPreview(deliverableHistory[currentVersionIndex]);
  updateVersionUI();
}

// ===== PREVIEW TOGGLE =====
function togglePreview() {
  const panel = document.getElementById('previewPanel');
  const btn = document.getElementById('previewToggle');
  if (panel.style.display === 'none') {
    panel.style.display = 'flex';
    btn.textContent = 'Preview';
  } else {
    panel.style.display = 'none';
    btn.textContent = 'Show Preview';
  }
}

// ===== PDF EXPORT =====
function exportPDF() {
  const iframe = document.getElementById('previewIframe');
  if (!iframe.srcdoc) {
    alert('No deliverable to export yet. Build one first through the conversation.');
    return;
  }
  iframe.contentWindow.print();
}

// ===== MODE SELECTION =====
function getModeInstructions() {
  const modes = {
    quick: `\n## Current mode\nThe user selected **Quick** mode. They want SPEED and DIRECTNESS.\n- Be concise. Short paragraphs, no fluff.\n- Skip the preamble — go straight to the answer or action.\n- If they share a URL, give the top 3–5 issues and a recommendation, not a 20-point audit.\n- Deliver the document/mockup fast. Don't ask "shall I proceed?" — just do it.\n- Only ask questions if something is truly ambiguous. Otherwise, make smart assumptions and move.\n- Think: busy professional who wants results NOW.`,
    guided: `\n## Current mode\nThe user selected **Guided** mode (default). Balance depth with collaboration.\n- Explain your reasoning, but stay focused.\n- Ask for input at key decision points (design direction, priority choices, pricing strategy).\n- Provide enough context so the user learns, but don't over-explain.\n- When generating deliverables, present the plan first, then build.\n- Think: collaborative working session where both parties contribute.`,
    thorough: `\n## Current mode\nThe user selected **Thorough** mode. They want DEPTH and COMPLETENESS.\n- Go deep on analysis. Cover every angle.\n- Include detailed breakdowns: tech stack, SEO, content, UX, accessibility, competitive positioning.\n- In documents, add data points, comparisons, before/after sections, and "why this matters" for every recommendation.\n- Don't rush. Take the time to be comprehensive.\n- When generating mockups, add more sections, more polish, more detail.\n- Ask clarifying questions to make sure nothing is missed.\n- Think: perfectionist who values quality over speed.`
  };
  return modes[currentMode] || modes.guided;
}

function setMode(mode, el) {
  currentMode = mode;
  document.querySelectorAll('.mode-pill').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
}

// ===== HELPERS =====
function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
  updateSendBtn();
}

function updateSendBtn() {
  const input = document.getElementById('userInput');
  document.getElementById('sendBtn').disabled = !input.value.trim() || isStreaming;
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
}

function escapeHtml(str) {
  return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>');
}

function renderMarkdown(text) {
  // Strip deliverable code blocks and replace with notice
  text = text.replace(/```html-deliverable\n[\s\S]*?```/g, '%%DELIVERABLE%%');

  // Check if this is a long response with ## sections — make them collapsible
  const hasSections = (text.match(/^## /gm) || []).length >= 2;

  if (hasSections) {
    return renderWithSections(text);
  }

  return renderBasicMarkdown(text);
}

function renderBasicMarkdown(text) {
  let html = escapeHtml(text);

  // Bold
  html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
  // Italic
  html = html.replace(/(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)/g, '<em>$1</em>');
  // Inline code
  html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
  // H2 headers
  html = html.replace(/^## (.*$)/gm, '<h2>$1</h2>');
  // H3 headers
  html = html.replace(/^### (.*$)/gm, '<h3>$1</h3>');
  // Horizontal rules
  html = html.replace(/^---$/gm, '<hr>');
  // Unordered lists
  html = html.replace(/^- (.*$)/gm, '<li>$1</li>');
  html = html.replace(/(<li>.*<\/li>(<br>)?)+/g, function(match) {
    return '<ul>' + match.replace(/<br>/g, '') + '</ul>';
  });
  // Numbered lists
  html = html.replace(/^\d+\. (.*$)/gm, '<li>$1</li>');
  // Blockquotes
  html = html.replace(/^&gt; (.*$)/gm, '<blockquote>$1</blockquote>');
  // Paragraphs
  html = html.replace(/\n\n/g, '</p><p>');
  html = '<p>' + html + '</p>';
  // Clean up
  html = html.replace(/<p><\/p>/g, '');
  html = html.replace(/<p>(<h[23]>)/g, '$1');
  html = html.replace(/(<\/h[23]>)<\/p>/g, '$1');
  html = html.replace(/<p>(<ul>)/g, '$1');
  html = html.replace(/(<\/ul>)<\/p>/g, '$1');
  html = html.replace(/<p>(<hr>)<\/p>/g, '$1');
  html = html.replace(/<p>(<blockquote>)/g, '$1');
  html = html.replace(/(<\/blockquote>)<\/p>/g, '$1');

  html = addDeliverableNotice(html);
  return html;
}

function renderWithSections(text) {
  // Split into intro + sections
  const parts = text.split(/^## /gm);
  const intro = parts[0].trim();
  const sections = parts.slice(1);

  let html = '';

  // Render intro (text before first ## section) as regular markdown
  if (intro) {
    html += renderBasicMarkdown(intro);
  }

  // Render each ## section as a collapsible block
  sections.forEach((section, i) => {
    const lines = section.split('\n');
    const title = lines[0].trim();
    const body = lines.slice(1).join('\n').trim();

    // Get first sentence or line as summary
    const firstLine = body.split('\n').find(l => l.trim() && !l.trim().startsWith('#')) || '';
    const summary = firstLine.replace(/\*\*/g, '').replace(/\*/g, '').substring(0, 120);

    const bodyHtml = renderBasicMarkdown(body);
    const sectionId = 'section-' + Date.now() + '-' + i;

    html += `
      <div class="msg-section" id="${sectionId}">
        <div class="msg-section-header" onclick="toggleSection('${sectionId}')">
          <span class="msg-section-title">${escapeHtml(title).replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</span>
          <span class="msg-section-toggle">▼</span>
        </div>
        ${summary ? `<div class="msg-section-summary">${escapeHtml(summary)}${summary.length >= 120 ? '...' : ''}</div>` : ''}
        <div class="msg-section-body">
          <div class="msg-section-body-inner">${bodyHtml}</div>
        </div>
      </div>
    `;
  });

  html = addDeliverableNotice(html);
  return html;
}

function toggleSection(id) {
  const el = document.getElementById(id);
  if (el) el.classList.toggle('open');
}

function addDeliverableNotice(html) {
  return html.replace(/%%DELIVERABLE%%/g, `
    <div class="deliverable-notice">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
        <polyline points="14 2 14 8 20 8"></polyline>
        <line x1="16" y1="13" x2="8" y2="13"></line>
        <line x1="16" y1="17" x2="8" y2="17"></line>
      </svg>
      Deliverable generated — see Preview panel
    </div>
  `);
}

// ===== EVENT LISTENERS =====
document.getElementById('userNameInput').addEventListener('input', () => {
  document.getElementById('setupStart').disabled =
    !document.getElementById('userNameInput').value.trim();
});
document.getElementById('userInput').addEventListener('input', () => updateSendBtn());

// Allow Enter in setup name field to start session
document.getElementById('userNameInput').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    if (!document.getElementById('setupStart').disabled) startSession();
  }
});

// Initial state
document.getElementById('setupStart').disabled = true;
</script>

<!-- Brand footer -->
<div class="brand-footer">
  <svg viewBox="0 0 100 100" fill="none">
    <path d="M50 5C50 5 25 20 20 45C15 70 30 90 50 95C70 90 85 70 80 45C75 20 50 5 50 5Z" fill="currentColor"/>
    <circle cx="50" cy="25" r="5" fill="#C41E3A"/>
  </svg>
  <span>FigSamurai</span>
</div>

</body>
</html>
